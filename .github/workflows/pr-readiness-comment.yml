name: PR Readiness Comment

# Uses pull_request_target so it runs with base repo permissions for forked PRs.
# SECURITY: We do NOT check out or execute PR code. We only use the GitHub API.
on:
  pull_request_target:
    types:
      - opened
      - reopened

permissions:
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - name: Add PR Readiness Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull_request in context. Skipping.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = pr.number;
            const leafUrl = `https://leaf.owaspblt.org/?owner=${owner}&repo=${repo}&pr=${pull_number}`;

            // Check if a readiness comment already exists to avoid duplicates
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pull_number,
              per_page: 100,
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('leaf.owaspblt.org/?')
            );

            if (existing) {
              core.info('Readiness comment already exists. Skipping.');
              return;
            }

            const body = [
              '## ğŸƒ PR Readiness Check',
              '',
              'Check the readiness of this PR on **Leaf**:',
              `ğŸ‘‰ [Open on Leaf](${leafUrl})`,
              '',
              '_Leaf reviews pull requests for operational readiness, security risks, and production-impacting changes before they ship._',
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body,
            });

            core.info(`Added readiness comment to PR #${pull_number}`);
