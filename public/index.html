<!DOCTYPE html>
<html lang="en" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR Readiness Checker - BLT-Leaf</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.tailwind = {
            config: {
                darkMode: 'class'
            }
        };

        // Initialize theme immediately to prevent FOUC
        (function () {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');

            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <script src="error-reporter.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* Fallback visibility if CDN is blocked */
        .btn-fallback {
            background: #E10000;
            color: #fff;
            border: 1px solid #BC0000;
        }

        /* Active PR row highlighting */
        .pr-row-active {
            background-color: #ffe4e6 !important; /* light red tint */
            border-left: 3px solid #ef4444;
        }

        .dark .pr-row-active {
            background-color: rgba(220, 38, 38, 0.18) !important; /* soft red glow */
            border-left: 3px solid #ef4444;
        }

        /* Dark mode fallback styles (when Tailwind CDN fails to load) */
        .dark {
            color-scheme: dark;
        }

        /* Body and main containers */
        .dark body {
            background-color: #0f172a !important; /* slate-900 */
            color: #f1f5f9 !important; /* slate-100 */
        }

        /* Header */
        .dark header {
            background-color: #1e293b !important; /* slate-800 */
            border-color: #334155 !important; /* slate-700 */
        }

        /* Sidebar */
        .dark aside {
            background-color: #1e293b !important; /* slate-800 */
            border-color: #334155 !important; /* slate-700 */
        }

        /* Cards and main content areas */
        .dark main > div,
        .dark .bg-white {
            background-color: #1e293b !important; /* slate-800 */
        }

        /* Text colors */
        .dark h1, .dark h2, .dark h3, .dark h4, .dark h5, .dark h6 {
            color: #ffffff !important;
        }

        .dark .text-slate-900 {
            color: #f1f5f9 !important; /* slate-100 */
        }

        .dark .text-slate-700 {
            color: #cbd5e1 ; /* slate-300 */
        }

        .dark .text-slate-600 {
            color: #cbd5e1 !important; /* slate-300 */
        }

        .dark .text-slate-500 {
            color: #94a3b8 !important; /* slate-400 */
        }

        .dark .text-slate-400 {
            color: #94a3b8 !important; /* slate-400 */
        }

        /* Inputs and form elements */
        .dark input[type="text"],
        .dark input[type="search"],
        .dark input[type="email"],
        .dark input[type="number"],
        .dark input[type="url"],
        .dark textarea,
        .dark select {
            background-color: #0f172a !important; /* slate-900 */
            color: #ffffff !important;
            border-color: #e74c3c !important;
        }

        .dark input::placeholder,
        .dark textarea::placeholder {
            color: #94a3b8 !important; /* slate-400 */
        }

        .dark input:focus,
        .dark textarea:focus,
        .dark select:focus {
            border-color: #ef4444 !important; /* red-500 */
            outline: none;
        }

        /* Buttons */
        .dark button:not(.bg-red-600):not([class*="bg-red"]):not([class*="bg-slate-500"]):not([class*="bg-green"]):not([class*="bg-blue"]) {
            background-color: #475569 !important; /* slate-600 */
            color: #f1f5f9 !important;
        }

        .dark button:hover:not(.bg-red-600):not([class*="bg-red"]):not([class*="bg-slate-500"]):not([class*="bg-green"]):not([class*="bg-blue"]) {
            background-color: #334155 !important; /* slate-700 */
        }

        /* Tables */
        .dark table {
            border-color: #334155 !important; /* slate-700 */
        }

        .dark th {
            background-color: #1e293b !important; /* slate-800 */
            color: #f1f5f9 !important;
            border-color: #334155 !important;
        }

        .dark td {
            border-color: #334155 !important; /* slate-700 */
            color: #e2e8f0 !important; /* slate-200 */
        }

        .dark tr:hover {
            background-color: #334155 !important; /* slate-700 */
        }

        /* Borders */
        .dark .border,
        .dark [class*="border-"] {
            border-color: #334155 !important; /* slate-700 */
        }

        .dark .border-slate-200 {
            border-color: #334155 !important; /* slate-700 */
        }

        .dark .divide-y > * {
            border-color: #334155 !important; /* slate-700 */
        }

        /* Hover states */
        .dark .hover\:bg-slate-100:hover,
        .dark [class*="hover:bg-slate-100"]:hover {
            background-color: #334155 !important; /* slate-700 */
        }

        .dark .hover\:bg-slate-50:hover {
            background-color: #1e293b !important; /* slate-800 */
        }

        /* Status badges and alerts */
        .dark .bg-slate-50 {
            background-color: #0f172a !important; /* slate-900 */
        }

        .dark .bg-slate-100 {
            background-color: #1e293b !important; /* slate-800 */
        }

        .dark .bg-slate-200 {
            background-color: #334155 !important; /* slate-700 */
        }

        /* Special background colors for status indicators */
        .dark .bg-green-50 {
            background-color: rgba(6, 78, 59, 0.3) !important; /* emerald-950/30 */
        }

        .dark .bg-red-50 {
            background-color: rgba(69, 10, 10, 0.3) !important; /* red-950/30 */
        }

        .dark .bg-amber-50,
        .dark .bg-yellow-50 {
            background-color: rgba(69, 26, 3, 0.3) !important; /* amber-950/30 */
        }

        /* Text colors for status indicators */
        .dark .text-green-700,
        .dark .text-green-600 {
            color: #4ade80 !important; /* green-400 */
        }

        .dark .text-emerald-700,
        .dark .text-emerald-600 {
            color: #34d399 !important; /* emerald-400 */
        }

        .dark .text-red-700,
        .dark .text-red-600 {
            color: #f87171 !important; /* red-400 */
        }

        .dark .text-amber-700,
        .dark .text-amber-600,
        .dark .text-yellow-700 {
            color: #fbbf24 !important; /* amber-400 */
        }

        .dark .text-orange-700,
        .dark .text-orange-600 {
            color: #fb923c !important; /* orange-400 */
        }

        .dark .text-blue-700,
        .dark .text-blue-600 {
            color: #60a5fa !important; /* blue-400 */
        }

        /* Links */
        .dark a {
            color: #60a5fa !important; /* blue-400 */
        }

        .dark a:hover {
            color: #93c5fd !important; /* blue-300 */
        }

        /* Disabled states */
        .dark button:disabled,
        .dark input:disabled {
            background-color: #450a0a !important; /* red-950 */
            border-color: #991b1b !important; /* red-800 */
            color: #f87171 !important; /* red-400 */
            opacity: 0.6;
        }

        /* Scrollbars */
        .dark ::-webkit-scrollbar {
            background-color: #1e293b;
        }

        .dark ::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background-color: #64748b;
        }
        
        /* Mobile autocomplete dropdown - responsive fallback */
        #repoList {
            display: none;
        }
        
        .mobile-repo-search {
            display: block;
        }
        
        @media (min-width: 768px) {
            #repoList {
                display: block;
            }
            
            .mobile-repo-search {
                display: none;
            }
        }

        @keyframes pr-row-glide-in {
            from {
                opacity: 0;
                transform: translateY(-6px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pr-row-glide-in {
            animation: pr-row-glide-in 0.25s ease-out forwards;
        }
    </style>
</head>

<body class="flex min-h-screen flex-col bg-slate-50 text-slate-900 antialiased dark:bg-slate-900 dark:text-slate-100">
    <header class="sticky top-0 z-30 border-b border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800">
        <div class="mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Mobile: Compact two-line layout -->
            <div class="flex flex-col gap-1.5 py-2 md:hidden">
                <!-- First line: Logo, title, and essential buttons -->
                <div class="flex items-center justify-between">
                    <a href="/" class="flex shrink-0 items-center gap-1.5 hover:opacity-80 transition-opacity">
                        <img width="20" src="./static/logo.png" alt="Logo" onerror="this.style.display='none'" />
                        <h1 class="text-xs font-bold text-slate-900 dark:text-white">BLT-LEAF</h1>
                    </a>
                    
                    <div class="flex items-center gap-1.5">
                        <button id="autoRefreshToggle"
                            class="rounded-lg p-1.5 text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700"
                            title="Toggle auto-refresh">
                            <i class="fas fa-sync-alt text-xs" id="autoRefreshIcon"></i>
                        </button>
                        <button id="themeToggle"
                            class="rounded-lg p-1.5 text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700">
                            <i class="fas fa-moon text-xs" id="themeIcon"></i>
                        </button>
                        <a href="/how-it-works.html"
                            class="inline-flex items-center rounded-lg p-1.5 text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700"
                            title="How It Works">
                            <i class="fas fa-question-circle text-xs"></i>
                        </a>
                        <a href="/diagnostics.html"
                            class="inline-flex items-center rounded-lg p-1.5 text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700"
                            title="API Diagnostics">
                            <i class="fas fa-stethoscope text-xs"></i>
                        </a>
                        <a href="https://github.com/OWASP-BLT/BLT-Leaf" target="_blank" rel="noopener noreferrer"
                            class="rounded-lg bg-red-600 p-1.5 text-white hover:bg-red-700"
                            title="Contribute">
                            <i class="fab fa-github text-xs"></i>
                        </a>
                        <a href="https://github.com/OWASP-BLT/BLT-Leaf/issues/new?template=feedback.yml" target="_blank" rel="noopener noreferrer"
                            class="rounded-lg bg-slate-600 p-1.5 text-white hover:bg-slate-700"
                            title="Send Feedback">
                            <i class="fas fa-comment-alt text-xs"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Second line: Search bar and API limit -->
                <div class="flex items-center gap-1.5">
                    <div class="relative flex-1">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-2">
                            <i class="fas fa-search text-slate-400 text-xs"></i>
                        </div>
                        <input type="text" id="prSearchInput"
                            class="block w-full rounded-md border border-[#e74c3c] bg-slate-50 py-1.5 pl-7 pr-2 text-xs text-slate-900 placeholder:text-slate-500 dark:border-[#e74c3c] dark:bg-slate-900 dark:text-white dark:placeholder:text-slate-400"
                            placeholder="Search PRs..." autocomplete="off">
                    </div>
                    <button id="searchBtn"
                        class="rounded-md bg-red-600 px-2 py-1.5 text-xs font-semibold text-white hover:bg-red-700 whitespace-nowrap">
                        <i class="fas fa-search"></i>
                    </button>
                    <button id="clearSearchBtn"
                        class="rounded-md bg-slate-500 px-2 py-1.5 text-xs font-semibold text-white hover:bg-slate-600 whitespace-nowrap">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Desktop: Original single-line layout -->
            <div class="hidden md:flex h-16 items-center justify-between">
                <div class="flex items-center gap-4 lg:gap-6">
                    <a href="/" class="flex shrink-0 items-center gap-2 hover:opacity-80 transition-opacity">
                        <img width="28" src="./static/logo.png" alt="Logo" onerror="this.style.display='none'" />
                        <h1 class="text-sm font-bold text-slate-900 dark:text-white sm:text-base">BLT-LEAF</h1>
                    </a>

                    <div class="flex items-center gap-1 sm:gap-2 pl-3 sm:pl-4 border-l border-slate-200 dark:border-slate-700 h-8">
                        <span class="text-[10px] font-medium text-slate-500 dark:text-slate-400">API Limit:</span>
                        <div class="rate-limit-bar h-1.5 w-20 overflow-hidden rounded-full bg-slate-200 dark:bg-slate-700">
                            <div class="h-full w-0 rounded-full bg-green-500 transition-all duration-300"
                                id="rateLimitFill"></div>
                        </div>
                        <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400"
                            id="rateLimitText">N/A</span>
                        <span class="text-[10px] text-slate-400 dark:text-slate-500" id="rateLimitUsed"></span>
                        <span class="text-[10px] text-slate-400 dark:text-slate-500" id="rateLimitReset"></span>
                        <span class="text-[10px] font-medium hidden" id="rateLimitTokenIndicator"></span>
                    </div>
                </div>

                <div class="flex flex-1 items-center justify-center px-4 md:px-8 lg:px-12">
                    <div class="flex w-full max-w-lg gap-2">
                        <div class="relative flex-1">
                            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                <i class="fas fa-search text-slate-400"></i>
                            </div>
                            <input type="text" id="prSearchInput"
                                class="block w-full rounded-md border border-[#e74c3c] bg-slate-50 py-2 pl-10 pr-3 text-sm text-slate-900 placeholder:text-slate-500 dark:border-[#e74c3c] dark:bg-slate-900 dark:text-white dark:placeholder:text-slate-400 dark:focus:border-red-500 transition-colors shadow-sm"
                                placeholder="Search PRs..." autocomplete="off">
                        </div>
                        <button id="searchBtn"
                            class="rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors shadow-sm whitespace-nowrap">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button id="clearSearchBtn"
                            class="rounded-md bg-slate-500 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors shadow-sm whitespace-nowrap">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <div class="flex shrink-0 items-center gap-3">
                    <button id="autoRefreshToggle"
                        class="rounded-lg p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 dark:focus:ring-slate-600 transition-colors"
                        title="Toggle auto-refresh">
                        <i class="fas fa-sync-alt" id="autoRefreshIcon"></i>
                    </button>
                    <button id="themeToggle"
                        class="rounded-lg p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 dark:focus:ring-slate-600">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <a href="/how-it-works.html"
                        class="inline-flex items-center gap-2 rounded-lg px-2 sm:px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 transition-colors"
                        title="How It Works">
                        <i class="fas fa-question-circle"></i>
                        <span class="hidden sm:inline">How It Works</span>
                    </a>
                    <a href="/diagnostics.html"
                        class="inline-flex items-center rounded-lg p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 dark:focus:ring-slate-600 transition-colors"
                        title="API Diagnostics">
                        <i class="fas fa-stethoscope"></i>
                    </a>
                    <span id="releaseVersion"
                        class="text-xs text-slate-500 dark:text-slate-400 inline-block"></span>
                    <a href="https://github.com/OWASP-BLT/BLT-Leaf" target="_blank" rel="noopener noreferrer"
                        class="rounded-lg bg-red-600 px-2 sm:px-3 py-2 text-sm font-semibold text-white hover:bg-red-700 inline-flex items-center gap-2 transition-colors shadow-sm"
                        title="Contribute">
                        <i class="fab fa-github"></i> <span class="hidden sm:inline">Contribute</span>
                    </a>
                    <a href="https://github.com/OWASP-BLT/BLT-Leaf/issues/new?template=feedback.yml" target="_blank" rel="noopener noreferrer"
                        class="rounded-lg bg-slate-600 px-2 sm:px-3 py-2 text-sm font-semibold text-white hover:bg-slate-700 inline-flex items-center gap-2 transition-colors shadow-sm"
                        title="Send Feedback">
                        <i class="fas fa-comment-alt"></i> <span class="hidden sm:inline">Feedback</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="mx-auto flex min-h-0 w-full flex-1 flex-col md:flex-row">
        <aside
            class="w-full border-b border-slate-200 bg-white md:w-72 md:border-b-0 md:border-r dark:border-slate-700 dark:bg-slate-800">
            <div class="p-4">
                <!-- Org filter autocomplete -->
                <div class="mb-3 relative" id="orgFilterContainer">
                    <label for="orgFilterInput" class="block mb-1 text-xs font-semibold uppercase tracking-[0.12em] text-slate-500 dark:text-slate-400">Filter by Org</label>
                    <div class="relative">
                        <input type="text" id="orgFilterInput"
                            class="w-full rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 placeholder:text-slate-400 focus:border-[#E10000] focus:outline-none focus:ring-1 focus:ring-[#E10000] dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500"
                            placeholder="All orgs..."
                            autocomplete="off"
                            aria-label="Filter repositories by organization" />
                        <button id="orgFilterClearBtn" type="button"
                            class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"
                            aria-label="Clear org filter">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                    <ul id="orgFilterDropdown" class="hidden absolute z-20 mt-1 w-full rounded-lg border border-slate-300 bg-white shadow-lg dark:border-slate-600 dark:bg-slate-700 max-h-48 overflow-y-auto"></ul>
                </div>

                <!-- Author filter -->
                <div class="mb-3 relative" id="authorFilterContainer">
                    <label for="authorFilterInput" class="block mb-1 text-xs font-semibold uppercase tracking-[0.12em] text-slate-500 dark:text-slate-400">Filter by Author</label>
                    <div class="relative">
                        <input type="text" id="authorFilterInput"
                            class="w-full rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 placeholder:text-slate-400 focus:border-[#E10000] focus:outline-none focus:ring-1 focus:ring-[#E10000] dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500"
                            placeholder="All authors..."
                            autocomplete="off"
                            aria-label="Filter pull requests by author" />
                        <button id="authorFilterClearBtn" type="button"
                            class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"
                            aria-label="Clear author filter">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                    <ul id="authorFilterDropdown" class="hidden absolute z-20 mt-1 w-full rounded-lg border border-slate-300 bg-white shadow-lg dark:border-slate-600 dark:bg-slate-700 max-h-48 overflow-y-auto"></ul>
                </div>

                <h2 class="mb-3 text-xs font-semibold uppercase tracking-[0.12em] text-slate-500 dark:text-slate-400">Repositories <span id="repoCountDisplay"></span>
                    <button id="repoSortBtn" title="Sort repositories by open PRs" onclick="toggleRepoSort()"
                        class="ml-1 inline-flex items-center rounded px-1 py-0.5 text-slate-400 hover:text-[#BC0000] dark:hover:text-red-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors align-middle"
                        aria-label="Sort repositories by open PRs">
                        <svg id="repoSortIcon" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M3 3a1 1 0 0 0 0 2h10a1 1 0 1 0 0-2H3zm2 4a1 1 0 0 0 0 2h6a1 1 0 1 0 0-2H5zm2 4a1 1 0 0 0 0 2h2a1 1 0 1 0 0-2H7z"/>
                        </svg>
                    </button>
                </h2>
                
                <!-- Mobile: Dropdown with search -->
                <div class="mobile-repo-search mb-2 md:hidden">
                    <div class="relative">
                        <button type="button" id="repoDropdownButton"
                            class="w-full flex items-center justify-between rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 hover:bg-slate-50 focus:border-[#E10000] focus:outline-none focus:ring-2 focus:ring-[#ffe3e3] dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 dark:focus:ring-red-900/50">
                            <span id="repoDropdownText" class="truncate">Select repository...</span>
                            <svg class="ml-2 h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Dropdown menu -->
                        <div id="repoDropdownMenu" class="hidden absolute z-10 mt-1 w-full rounded-lg border border-slate-300 bg-white shadow-lg dark:border-slate-600 dark:bg-slate-700">
                            <div class="p-2 border-b border-slate-200 dark:border-slate-600">
                                <input type="text" id="repoSearchInput"
                                    class="w-full rounded-md border border-slate-300 bg-white px-2 py-1.5 text-sm text-slate-900 placeholder:text-slate-400 focus:border-[#E10000] focus:outline-none focus:ring-1 focus:ring-[#E10000] dark:border-slate-500 dark:bg-slate-600 dark:text-slate-100 dark:placeholder:text-slate-400"
                                    placeholder="Search repositories..."
                                    autocomplete="off" />
                            </div>
                            <div id="repoDropdownList" class="max-h-60 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Desktop: List view -->
                <ul id="repoList" class="space-y-2">
                    <li class="repo-item active cursor-pointer rounded-lg border border-[#f5b0b0] bg-[#fff1f1] px-3 py-2 dark:border-red-900 dark:bg-red-950/30"
                        data-repo="all">
                        <div class="repo-name text-sm font-semibold text-[#BC0000] dark:text-red-400">All Repositories
                        </div>
                        <div class="repo-count mt-0.5 text-xs text-slate-500 dark:text-slate-400" id="allReposCount">0
                            PRs</div>
                    </li>
                </ul>
            </div>
        </aside>

        <main class="min-h-0 flex-1 overflow-y-auto p-4 sm:p-6">
            <section class="mb-6 space-y-3">
                <div class="flex w-full max-w-4xl flex-col gap-2 sm:flex-row">
                    <input type="text" id="prUrlInput"
                        class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm text-slate-900 placeholder:text-slate-400 focus:border-[#E10000] focus:outline-none focus:ring-2 focus:ring-[#ffe3e3] dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-red-900/50"
                        placeholder="Enter GitHub PR URL, Repository URL, or Organization URL" autocomplete="off" />
                    <button id="addPrBtn"
                        class="btn-fallback w-[6rem] rounded-lg px-4 py-2.5 text-sm font-semibold transition-colors hover:bg-[#BC0000] disabled:cursor-not-allowed disabled:border-red-300 disabled:bg-red-200 disabled:text-red-700 dark:disabled:border-red-800 dark:disabled:bg-red-950 dark:disabled:text-red-400">
                        Add PR
                    </button>
                </div>

                <div class="mt-2 flex items-center gap-2">
                    <input type="checkbox" id="addAllPrsCheckbox"
                        class="h-4 w-4 rounded border-slate-300 text-[#E10000] focus:ring-[#E10000] dark:border-slate-600 dark:bg-slate-700">
                    <label for="addAllPrsCheckbox"
                        class="text-sm text-slate-600 dark:text-slate-400 cursor-pointer select-none">
                        Add all active PRs from this repo or organization
                    </label>
                </div>
            </section>

            <div id="prListContainer">
                <div
                    class="rounded-xl border border-dashed border-slate-300 bg-white p-10 text-center dark:border-slate-600 dark:bg-slate-800">
                    <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">No PRs Added Yet</h3>
                    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Add a GitHub PR URL above to start
                        tracking</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Raw Data Modal -->
    <div id="rawDataModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="relative w-full max-w-4xl max-h-[90vh] m-4 bg-white dark:bg-slate-800 rounded-lg shadow-2xl flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100">Raw PR Data</h2>
                <button id="closeRawDataModal" class="rounded-lg p-2 text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="flex-1 overflow-auto px-6 py-4">
                <pre id="rawDataContent" class="text-xs text-slate-700 dark:text-slate-300 bg-slate-50 dark:bg-slate-900 p-4 rounded-lg overflow-x-auto"><code></code></pre>
            </div>
            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-slate-200 dark:border-slate-700">
                <button id="copyRawDataBtn" class="rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors shadow-sm">
                    <i class="fas fa-copy mr-1"></i>Copy to Clipboard
                </button>
                <button id="closeRawDataModalBtn" class="rounded-md bg-slate-500 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors shadow-sm">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentRepo = localStorage.getItem('currentRepo') || 'all';
        let currentOrg = localStorage.getItem('currentOrg') || '';
        let currentAuthor = localStorage.getItem('currentAuthor') || '';
        let allPrs = [];
        let repos = [];
        let allAuthors = []; // All unique authors from the database (including bots)
        let repoSortByPrs = localStorage.getItem('repoSortByPrs') !== 'false';
        // Support unlimited sort columns
        // Each entry in sortColumns array has: {column: 'column_name', direction: 'asc'|'desc'}
        let sortColumns = [];
        try {
            const savedSort = localStorage.getItem('sortColumns');
            if (savedSort) {
                sortColumns = JSON.parse(savedSort);
            } else {
                // Migrate from old single/dual column format
                const oldPrimary = localStorage.getItem('sortColumn') || 'ready_score';
                const oldPrimaryDir = localStorage.getItem('sortDirection') || 'desc';
                sortColumns.push({ column: oldPrimary, direction: oldPrimaryDir });

                const oldSecondary = localStorage.getItem('secondarySortColumn');
                if (oldSecondary) {
                    const oldSecondaryDir = localStorage.getItem('secondarySortDirection') || 'desc';
                    sortColumns.push({ column: oldSecondary, direction: oldSecondaryDir });
                }
            }
        } catch (e) {
            // Fallback to default
            sortColumns = [{ column: 'ready_score', direction: 'desc' }];
        }

        // Ensure at least one sort column exists
        if (sortColumns.length === 0) {
            sortColumns = [{ column: 'ready_score', direction: 'desc' }];
        }
        let currentPage = 1;
        let totalPages = 1;
        // Load and validate perPage from localStorage
        let perPageRaw = localStorage.getItem('perPage');
        let perPageParsed = parseInt(perPageRaw, 10);
        let perPage = (!Number.isNaN(perPageParsed) && perPageParsed >= 10 && perPageParsed <= 1000)
            ? perPageParsed
            : 30; // Ensure perPage is within [10, 1000], fallback to 30 if invalid
        let activePrId = null; // Track the currently active/selected PR

        // Auto-refresh state
        let autoRefreshEnabled = localStorage.getItem('autoRefreshEnabled') !== 'false'; // enabled by default
        let autoRefreshInterval = null;
        let prUpdateTimestamps = {}; // Track PR update timestamps for change detection
        const AUTO_REFRESH_INTERVAL = 30000; // 30 seconds
        const FEEDBACK_DISMISS_DELAY = 5000; // 5 seconds

        // Helper functions for readiness data persistence
        function saveReadinessData(prId, readiness, reviewHealth) {
            try {
                const data = JSON.parse(localStorage.getItem('prReadinessData') || '{}');
                data[prId] = {
                    readiness,
                    reviewHealth,
                    timestamp: Date.now()
                };
                localStorage.setItem('prReadinessData', JSON.stringify(data));

                // Also update the PR object in allPrs for sorting
                const pr = allPrs.find(p => p.id === prId);
                if (pr) {
                    pr.ready_score = readiness.overall_score;
                    pr.ci_score = readiness.ci_score;
                    pr.review_score = readiness.review_score;
                    pr.response_score = parseFloat(reviewHealth.response_rate_display.replace('%', ''));
                    pr.feedback_score = reviewHealth.total_feedback > 0 ?
                        (reviewHealth.responded_feedback / reviewHealth.total_feedback) * 100 : 100;
                    pr.issues_count = (readiness.blockers?.length || 0) + (readiness.warnings?.length || 0);
                }
            } catch (error) {
                console.error('Error saving readiness data:', error);
            }
        }

        function loadReadinessData(prId) {
            try {
                const data = JSON.parse(localStorage.getItem('prReadinessData') || '{}');
                return data[prId] || null;
            } catch (error) {
                console.error('Error loading readiness data:', error);
                return null;
            }
        }

        function clearReadinessData(prId) {
            try {
                const data = JSON.parse(localStorage.getItem('prReadinessData') || '{}');
                delete data[prId];
                localStorage.setItem('prReadinessData', JSON.stringify(data));
            } catch (error) {
                console.error('Error clearing readiness data:', error);
            }
        }

        const repoItemBaseClasses = ['repo-item', 'cursor-pointer', 'rounded-lg', 'border', 'px-3', 'py-2', 'transition-colors'];
        const repoItemIdleClasses = ['border-slate-200', 'bg-white', 'hover:border-slate-300', 'hover:bg-slate-50', 'dark:border-slate-700', 'dark:bg-slate-800', 'dark:hover:border-slate-600', 'dark:hover:bg-slate-700'];
        const repoItemActiveClasses = ['active', 'border-[#f5b0b0]', 'bg-[#fff1f1]', 'dark:border-red-900', 'dark:bg-red-950/30'];

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getRepoAvatarUrl(repo) {
            if (repo.repo_owner_avatar &&
                (repo.repo_owner_avatar.startsWith('https://avatars.githubusercontent.com/') ||
                 repo.repo_owner_avatar.startsWith('https://github.com/'))) {
                return escapeHtml(repo.repo_owner_avatar);
            }
            return `https://github.com/${escapeHtml(repo.repo_owner)}.png`;
        }

        function renderReviewerAvatars(reviewersJson) {
            let reviewers = [];
            try {
                if (typeof reviewersJson === 'string') {
                    reviewers = JSON.parse(reviewersJson);
                } else if (Array.isArray(reviewersJson)) {
                    reviewers = reviewersJson;
                }
            } catch (e) {
                return '<span class="text-xs text-slate-400 dark:text-slate-500">-</span>';
            }
            if (!reviewers || reviewers.length === 0) {
                return '<span class="text-xs text-slate-400 dark:text-slate-500">-</span>';
            }

            // Border color per review state
            const borderColor = {
                'APPROVED': 'border-emerald-400 dark:border-emerald-500',
                'CHANGES_REQUESTED': 'border-red-400 dark:border-red-500',
                'COMMENTED': 'border-amber-400 dark:border-amber-500',
                'PENDING': 'border-slate-300 dark:border-slate-500',
                'DISMISSED': 'border-slate-300 dark:border-slate-500'
            };

            const avatarHtml = reviewers.map((r, i) => {
                const ml = i > 0 ? 'margin-left: -6px;' : '';
                const zIndex = `z-index: ${reviewers.length - i};`;
                const border = borderColor[r.state] || borderColor['PENDING'];
                const safeAvatar = r.avatar_url &&
                    (r.avatar_url.startsWith('https://avatars.githubusercontent.com/') || r.avatar_url.startsWith('https://github.com/'))
                    ? escapeHtml(r.avatar_url)
                    : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22%3E%3Crect width=%2220%22 height=%2220%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E';
                const stateLabel = r.state ? r.state.replace('_', ' ').toLowerCase() : 'pending';
                return `<img src="${safeAvatar}" alt="${escapeHtml(r.login)}" title="${escapeHtml(r.login)} (${stateLabel})" class="inline-block h-5 w-5 rounded-full border-2 ${border} bg-white dark:bg-slate-800" style="${ml} ${zIndex} position: relative;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22%3E%3Crect width=%2220%22 height=%2220%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'">`;
            }).join('');

            return `<div class="flex items-center" style="min-width: fit-content;">${avatarHtml}</div>`;
        }

        function renderAuthorWithChecks(avatarUrl, authorLogin, passed, failed, skipped, orgAvatarUrl, orgName) {
            const safeAvatar = avatarUrl &&
                (avatarUrl.startsWith('https://avatars.githubusercontent.com/') || avatarUrl.startsWith('https://github.com/'))
                ? escapeHtml(avatarUrl)
                : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2244%22 height=%2244%22%3E%3Crect width=%2244%22 height=%2244%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E';
            const p = passed || 0;
            const f = failed || 0;
            const s = skipped || 0;
            const total = p + f + s;
            // SVG ring dimensions
            const svgSize = 56;
            const cx = svgSize / 2;
            const cy = svgSize / 2;
            const r = 26.5;
            const circumference = 2 * Math.PI * r;
            const avatarSize = 44;
            const avatarOffset = (svgSize - avatarSize) / 2;
            let arcs = `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#e2e8f0" stroke-width="3" class="dark:stroke-slate-700"/>`;
            if (total > 0) {
                const passedLen = (p / total) * circumference;
                const failedLen = (f / total) * circumference;
                const skippedLen = (s / total) * circumference;
                if (p > 0) {
                    arcs += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#22c55e" stroke-width="3" stroke-dasharray="${passedLen} ${circumference}" stroke-dashoffset="0" transform="rotate(-90 ${cx} ${cy})"/>`;
                }
                if (f > 0) {
                    arcs += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#ef4444" stroke-width="3" stroke-dasharray="${failedLen} ${circumference}" stroke-dashoffset="${-passedLen}" transform="rotate(-90 ${cx} ${cy})"/>`;
                }
                if (s > 0) {
                    arcs += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#94a3b8" stroke-width="3" stroke-dasharray="${skippedLen} ${circumference}" stroke-dashoffset="${-(passedLen + failedLen)}" transform="rotate(-90 ${cx} ${cy})"/>`;
                }
            }
            const checksParts = [];
            if (p > 0) checksParts.push(`${p} passed`);
            if (f > 0) checksParts.push(`${f} failed`);
            if (s > 0) checksParts.push(`${s} skipped`);
            const checksTitle = checksParts.length > 0 ? checksParts.join(', ') : 'No checks';
            const onerror = `this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22${avatarSize}%22 height=%22${avatarSize}%22%3E%3Crect width=%22${avatarSize}%22 height=%22${avatarSize}%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'`;
            const orgIconSize = 18;
            const orgIconLeft = svgSize - orgIconSize;
            const orgIconTop = svgSize - orgIconSize;
            const orgOnerror = `this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22${orgIconSize}%22 height=%22${orgIconSize}%22%3E%3Crect width=%22${orgIconSize}%22 height=%22${orgIconSize}%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'`;
            const safeOrgAvatar = orgAvatarUrl &&
                (orgAvatarUrl.startsWith('https://avatars.githubusercontent.com/') || orgAvatarUrl.startsWith('https://github.com/'))
                ? escapeHtml(orgAvatarUrl)
                : null;
            const orgOverlay = safeOrgAvatar
                ? `<img src="${safeOrgAvatar}" alt="${escapeHtml(orgName || '')}" title="${escapeHtml(orgName || '')}" class="absolute rounded-full border-2 border-white dark:border-slate-800" style="width:${orgIconSize}px;height:${orgIconSize}px;top:${orgIconTop}px;left:${orgIconLeft}px;" onerror="${orgOnerror}">`
                : '';
            return `<div class="relative flex-shrink-0" style="width:${svgSize}px;height:${svgSize}px;" title="${escapeHtml(checksTitle)}">
                <svg width="${svgSize}" height="${svgSize}" viewBox="0 0 ${svgSize} ${svgSize}" class="absolute inset-0">${arcs}</svg>
                <img src="${safeAvatar}" alt="${escapeHtml(authorLogin)}" class="absolute rounded-full border border-slate-200 dark:border-slate-600" style="width:${avatarSize}px;height:${avatarSize}px;top:${avatarOffset}px;left:${avatarOffset}px;" onerror="${onerror}">
                ${orgOverlay}
            </div>`;
        }

        function setRepoItemActiveState(item, isActive) {
            item.className = '';
            item.classList.add(...repoItemBaseClasses);
            item.classList.add(...(isActive ? repoItemActiveClasses : repoItemIdleClasses));

            const nameEl = item.querySelector('.repo-name');
            if (nameEl) {
                nameEl.className = `repo-name text-sm font-semibold ${isActive ? 'text-[#BC0000] dark:text-red-400' : 'text-slate-800 dark:text-slate-200'}`;
            }
        }

        async function loadRateLimit(bypassCache = false) {
            try {
                const MS_PER_MINUTE = 60000;
                const MINUTES_PER_HOUR = 60;

                const url = bypassCache ? `/api/rate-limit?_=${Date.now()}` : '/api/rate-limit';
                const response = await fetch(url);
                const textEl = document.getElementById('rateLimitText');
                const fillEl = document.getElementById('rateLimitFill');
                const usedEl = document.getElementById('rateLimitUsed');
                const resetEl = document.getElementById('rateLimitReset');
                const tokenEl = document.getElementById('rateLimitTokenIndicator');

                if (!response.ok) return;

                const data = await response.json();

                // Show token indicator regardless of rate limit status
                if (tokenEl) {
                    if (data.token_configured) {
                        tokenEl.textContent = 'ðŸ”‘';
                        tokenEl.title = 'GitHub token configured (higher rate limits)';
                        tokenEl.setAttribute('aria-label', 'GitHub token configured');
                        tokenEl.classList.remove('hidden');
                    } else {
                        tokenEl.textContent = 'âš ';
                        tokenEl.title = 'No GitHub token configured (lower rate limits)';
                        tokenEl.setAttribute('aria-label', 'No GitHub token configured');
                        tokenEl.classList.remove('hidden');
                    }
                }

                if (data.status === 'waiting_for_first_request') {
                    if (textEl) textEl.textContent = 'Ready';
                    if (usedEl) usedEl.textContent = '';
                    if (resetEl) resetEl.textContent = '';
                    if (fillEl) fillEl.style.width = '100%';
                    return;
                }
                if (data.error) {
                    if (textEl) textEl.textContent = 'N/A';
                    return;
                }

                const { limit, remaining, used, reset } = data;
                if (typeof limit !== 'number' || typeof remaining !== 'number') {
                    if (textEl) textEl.textContent = 'N/A';
                    return;
                }

                const percentageRemaining = (remaining / limit) * 100;

                if (fillEl) {
                    fillEl.style.width = `${percentageRemaining}%`;
                    fillEl.className = 'h-full rounded-full transition-all duration-300';
                    if (percentageRemaining < 20) {
                        fillEl.classList.add('bg-red-600');
                    } else if (percentageRemaining <= 50) {
                        fillEl.classList.add('bg-amber-500');
                    } else {
                        fillEl.classList.add('bg-green-500');
                    }
                }

                if (textEl) textEl.textContent = `${remaining} / ${limit}`;

                // Display used count
                if (usedEl && typeof used === 'number') {
                    usedEl.textContent = `(${used} used)`;
                }

                // Display reset time in human-readable format
                if (resetEl && typeof reset === 'number') {
                    const resetDate = new Date(reset * 1000);
                    const now = new Date();
                    const diffMs = resetDate - now;
                    const diffMins = Math.floor(diffMs / MS_PER_MINUTE);

                    if (diffMins <= 0) {
                        resetEl.textContent = 'Resets soon';
                    } else if (diffMins < MINUTES_PER_HOUR) {
                        resetEl.textContent = `Resets in ${diffMins}m`;
                    } else {
                        const diffHours = Math.floor(diffMins / MINUTES_PER_HOUR);
                        const remainingMins = diffMins % MINUTES_PER_HOUR;
                        if (remainingMins === 0) {
                            resetEl.textContent = `Resets in ${diffHours}h`;
                        } else {
                            resetEl.textContent = `Resets in ${diffHours}h ${remainingMins}m`;
                        }
                    }
                }

            } catch (error) {
                console.error('Error loading rate limit:', error);
                const textEl = document.getElementById('rateLimitText');
                const usedEl = document.getElementById('rateLimitUsed');
                const resetEl = document.getElementById('rateLimitReset');
                const tokenEl = document.getElementById('rateLimitTokenIndicator');
                if (textEl) textEl.textContent = 'N/A';
                if (usedEl) usedEl.textContent = '';
                if (resetEl) resetEl.textContent = '';
                if (tokenEl) tokenEl.classList.add('hidden');
            }
        }

        async function loadLatestRelease() {
            try {
                const response = await fetch('https://api.github.com/repos/OWASP-BLT/BLT-Leaf/releases/latest');

                if (!response.ok) {
                    return; // Silently fail - don't show version if API fails
                }

                const data = await response.json();
                const versionEl = document.getElementById('releaseVersion');

                if (data.tag_name && versionEl) {
                    versionEl.textContent = data.tag_name;
                    versionEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading latest release:', error);
                // Silently fail - don't show version if fetch fails
            }
        }

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [name, value] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / value);
                if (interval >= 1) return `${interval} ${name}${interval === 1 ? '' : 's'} ago`;
            }

            return 'just now';
        }

        function sortPrs(column, isShiftClick = false) {
            if (isShiftClick) {
                // Shift+click adds or modifies additional sort columns
                const existingIndex = sortColumns.findIndex(sc => sc.column === column);

                if (existingIndex >= 0) {
                    // Column already in sort list - toggle its direction
                    sortColumns[existingIndex].direction =
                        sortColumns[existingIndex].direction === 'asc' ? 'desc' : 'asc';
                } else {
                    // Add new sort column
                    sortColumns.push({ column: column, direction: 'desc' });
                }
            } else {
                // Regular click - set as primary sort (first position)
                const existingIndex = sortColumns.findIndex(sc => sc.column === column);

                if (existingIndex === 0) {
                    // Already primary sort - toggle direction
                    sortColumns[0].direction = sortColumns[0].direction === 'asc' ? 'desc' : 'asc';
                } else if (existingIndex > 0) {
                    // Move to primary and toggle direction
                    const existing = sortColumns.splice(existingIndex, 1)[0];
                    existing.direction = existing.direction === 'asc' ? 'desc' : 'asc';
                    sortColumns.unshift(existing);
                } else {
                    // New primary sort column
                    sortColumns.unshift({ column: column, direction: 'desc' });
                }
            }

            // Save sorting state to localStorage
            localStorage.setItem('sortColumns', JSON.stringify(sortColumns));

            // Reset to first page when sorting changes
            currentPage = 1;

            // Reload PRs from server with new sort parameters
            loadPrs();
        }

        function showInlineError(rowId, message) {
            // Show error message in the specific PR row
            const row = document.getElementById(rowId);
            if (!row) return;

            // Create error cell that spans all columns
            const errorCell = document.createElement('td');
            errorCell.colSpan = 22; // Total number of columns in the table
            errorCell.className = 'px-2 py-3';
            errorCell.innerHTML = `
                <div class="flex items-start gap-2 rounded-lg border border-red-200 border-l-4 border-l-red-600 bg-red-50 px-3 py-2.5 text-sm text-red-900 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">
                    <span class="inline-flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-xs font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                    <div class="leading-5">${escapeHtml(message)}</div>
                </div>
            `;

            // Replace all cells with the error cell
            row.innerHTML = '';
            row.appendChild(errorCell);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (row && row.parentNode) {
                    errorCell.remove();
                }
            }, 5000);
        }

        function showContainerError(containerId, message) {
            // Show error message in a container (for loading errors)
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = `
                <div class="rounded-xl border border-red-200 bg-white p-8 dark:border-red-900 dark:bg-slate-800">
                    <div class="flex items-start gap-3">
                        <span class="inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-sm font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-2">Error</h3>
                            <p class="text-sm text-slate-700 dark:text-slate-300">${escapeHtml(message)}</p>
                        </div>
                    </div>
                </div>
            `;

            // Auto-dismiss after 5 seconds
            const errorDiv = container.querySelector('.rounded-xl');
            setTimeout(() => {
                if (errorDiv && errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function showInputError(inputId, message) {
            // Show error message near an input field
            const input = document.getElementById(inputId);
            if (!input) return;

            // Remove any existing error message
            const container = input.closest('section');
            const existingError = container.querySelector('.input-error-message');
            if (existingError) {
                existingError.remove();
            }

            // Create error message element
            const errorElement = document.createElement('div');
            errorElement.className = 'input-error-message flex items-start gap-2 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-900 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400 w-full max-w-4xl';
            errorElement.innerHTML = `
                <span class="inline-flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-xs font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                <div class="leading-5">${escapeHtml(message)}</div>
            `;

            // Insert after the parent flex div
            const parentDiv = input.parentElement;
            parentDiv.after(errorElement);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                errorElement.remove();
            }, FEEDBACK_DISMISS_DELAY);
        }

        function showError(message) {
            // Show a temporary global error message (toast) â€” used for non-import errors
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 z-[100] flex items-start gap-2 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-900 shadow-lg dark:border-red-900 dark:bg-red-950/30 dark:text-red-400 max-w-md animate-slide-in';
            toast.innerHTML = `
                <span class="inline-flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-xs font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                <div class="leading-5">${escapeHtml(message)}</div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => toast.remove(), 500);
            }, FEEDBACK_DISMISS_DELAY);
        }

        function showSectionMessage(message, type) {
            // Show an inline feedback message in the Add PR section on the page
            const section = document.getElementById('prUrlInput')?.closest('section');
            if (!section) {
                console.warn('showSectionMessage: Add PR section not found');
                return;
            }
            const existing = section.querySelector('.section-feedback-message');
            if (existing) existing.remove();
            const styles = {
                error:   { border: 'border-red-200',    bg: 'bg-red-50',    text: 'text-red-900',    dark: 'dark:border-red-900 dark:bg-red-950/30 dark:text-red-400',    iconBg: 'bg-red-100',    iconText: 'text-red-700',    darkIcon: 'dark:bg-red-900 dark:text-red-400',    icon: '!' },
                success: { border: 'border-green-200',  bg: 'bg-green-50',  text: 'text-green-900',  dark: 'dark:border-green-900 dark:bg-green-950/30 dark:text-green-400',  iconBg: 'bg-green-100',  iconText: 'text-green-700',  darkIcon: 'dark:bg-green-900 dark:text-green-400',  icon: 'âœ“' },
                warning: { border: 'border-yellow-200', bg: 'bg-yellow-50', text: 'text-yellow-900', dark: 'dark:border-yellow-900 dark:bg-yellow-950/30 dark:text-yellow-400', iconBg: 'bg-yellow-100', iconText: 'text-yellow-700', darkIcon: 'dark:bg-yellow-900 dark:text-yellow-400', icon: 'âš ' },
            };
            const s = styles[type] || styles.error;
            const el = document.createElement('div');
            el.className = `section-feedback-message flex items-start gap-2 rounded-lg border ${s.border} ${s.bg} px-3 py-2 text-sm ${s.text} ${s.dark} w-full max-w-4xl`;
            el.innerHTML = `
                <span class="inline-flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full ${s.iconBg} text-xs font-bold ${s.iconText} ${s.darkIcon}">${s.icon}</span>
                <div class="leading-5">${escapeHtml(message)}</div>
            `;
            section.appendChild(el);
            setTimeout(() => el.remove(), FEEDBACK_DISMISS_DELAY);
        }

        function showSuccess(message) {
            showSectionMessage(message, 'success');
        }

        function showWarning(message) {
            showSectionMessage(message, 'warning');
        }

        function toggleRepoSort() {
            repoSortByPrs = !repoSortByPrs;
            localStorage.setItem('repoSortByPrs', repoSortByPrs);
            renderRepoList();
        }

        function getUniqueOrgs() {
            const orgs = [...new Set(repos.map(r => r.repo_owner))].sort();
            return orgs;
        }

        function initOrgFilter() {
            const input = document.getElementById('orgFilterInput');
            const dropdown = document.getElementById('orgFilterDropdown');
            const clearBtn = document.getElementById('orgFilterClearBtn');
            if (!input || !dropdown || !clearBtn) return;

            // Set initial value from saved state
            if (currentOrg) {
                input.value = currentOrg;
                clearBtn.classList.remove('hidden');
            }

            function renderOrgDropdown(filter) {
                const orgs = getUniqueOrgs().filter(o =>
                    !filter || o.toLowerCase().includes(filter.toLowerCase())
                );
                dropdown.innerHTML = '';
                if (orgs.length === 0) {
                    dropdown.classList.add('hidden');
                    return;
                }
                orgs.forEach(org => {
                    const li = document.createElement('li');
                    li.className = 'px-3 py-2 text-sm cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-900 dark:text-slate-100' +
                        (org === currentOrg ? ' bg-red-50 dark:bg-red-950/30 font-semibold' : '');
                    li.textContent = org;
                    li.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        selectOrg(org);
                    });
                    dropdown.appendChild(li);
                });
                dropdown.classList.remove('hidden');
            }

            function selectOrg(org) {
                currentOrg = org;
                localStorage.setItem('currentOrg', currentOrg);
                input.value = org;
                clearBtn.classList.remove('hidden');
                dropdown.classList.add('hidden');
                // Reset to "all repos" within this org and reload
                currentRepo = 'all';
                localStorage.setItem('currentRepo', currentRepo);
                currentPage = 1;
                renderRepoList();
                loadPrs();
            }

            input.addEventListener('focus', () => {
                renderOrgDropdown(input.value);
            });

            input.addEventListener('input', () => {
                const val = input.value.trim();
                clearBtn.classList.toggle('hidden', !val);
                renderOrgDropdown(val);
                // If cleared entirely, reset org filter
                if (!val && currentOrg) {
                    currentOrg = '';
                    localStorage.setItem('currentOrg', '');
                    currentPage = 1;
                    renderRepoList();
                    loadPrs();
                }
            });

            input.addEventListener('blur', () => {
                // Delay hiding to allow mousedown on items to fire
                setTimeout(() => dropdown.classList.add('hidden'), 150);
            });

            clearBtn.addEventListener('click', () => {
                input.value = '';
                clearBtn.classList.add('hidden');
                dropdown.classList.add('hidden');
                currentOrg = '';
                localStorage.setItem('currentOrg', '');
                currentPage = 1;
                renderRepoList();
                loadPrs();
            });
        }

        function getUniqueAuthors() {
            // Use server-fetched allAuthors list (includes bots and authors not on current page)
            // Fall back to authors from currently loaded PRs if allAuthors is not yet populated
            if (allAuthors.length > 0) {
                return allAuthors;
            }
            return [...new Set(allPrs.map(pr => pr.author_login).filter(Boolean))].sort();
        }

        function initAuthorFilter() {
            const input = document.getElementById('authorFilterInput');
            const dropdown = document.getElementById('authorFilterDropdown');
            const clearBtn = document.getElementById('authorFilterClearBtn');
            if (!input || !dropdown || !clearBtn) return;

            // Set initial value from saved state
            if (currentAuthor) {
                input.value = currentAuthor;
                clearBtn.classList.remove('hidden');
            }

            function renderAuthorDropdown(filter) {
                const authors = getUniqueAuthors().filter(a =>
                    !filter || a.toLowerCase().includes(filter.toLowerCase())
                );
                dropdown.innerHTML = '';
                if (authors.length === 0) {
                    dropdown.classList.add('hidden');
                    return;
                }
                authors.forEach(author => {
                    const li = document.createElement('li');
                    li.className = 'px-3 py-2 text-sm cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-900 dark:text-slate-100' +
                        (author === currentAuthor ? ' bg-red-50 dark:bg-red-950/30 font-semibold' : '');
                    li.textContent = author;
                    li.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        selectAuthor(author);
                    });
                    dropdown.appendChild(li);
                });
                dropdown.classList.remove('hidden');
            }

            function selectAuthor(author) {
                currentAuthor = author;
                localStorage.setItem('currentAuthor', currentAuthor);
                input.value = author;
                clearBtn.classList.remove('hidden');
                dropdown.classList.add('hidden');
                currentPage = 1;
                loadPrs();
            }

            input.addEventListener('focus', () => {
                renderAuthorDropdown(input.value);
            });

            input.addEventListener('input', () => {
                const val = input.value.trim();
                clearBtn.classList.toggle('hidden', !val);
                renderAuthorDropdown(val);
                // If cleared entirely, reset author filter
                if (!val && currentAuthor) {
                    currentAuthor = '';
                    localStorage.setItem('currentAuthor', '');
                    currentPage = 1;
                    loadPrs();
                }
            });

            input.addEventListener('blur', () => {
                // Delay hiding to allow mousedown on items to fire
                setTimeout(() => dropdown.classList.add('hidden'), 150);
            });

            clearBtn.addEventListener('click', () => {
                input.value = '';
                clearBtn.classList.add('hidden');
                dropdown.classList.add('hidden');
                currentAuthor = '';
                localStorage.setItem('currentAuthor', '');
                currentPage = 1;
                loadPrs();
            });
        }

        function scrollToTop() {
            const mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.scrollTo({ top: 0, behavior: 'instant' });
            }
            window.scrollTo({ top: 0, behavior: 'instant' });
        }

        async function loadRepos(bypassCache = false) {
            try {
                const response = bypassCache
                    ? await fetch(`/api/repos?_=${Date.now()}`)
                    : await fetch('/api/repos');
                const data = await response.json();

                if (data.error) {
                    console.error('Error loading repos:', data.error);
                    return;
                }

                repos = data.repos;
                // Validate saved org filter against loaded repos
                if (currentOrg && !repos.some(r => r.repo_owner === currentOrg)) {
                    currentOrg = '';
                    localStorage.setItem('currentOrg', '');
                    const input = document.getElementById('orgFilterInput');
                    const clearBtn = document.getElementById('orgFilterClearBtn');
                    if (input) input.value = '';
                    if (clearBtn) clearBtn.classList.add('hidden');
                }
                renderRepoList();
            } catch (error) {
                console.error('Error loading repos:', error);
            }
        }

        async function loadAuthors(bypassCache = false) {
            try {
                const response = bypassCache
                    ? await fetch(`/api/authors?_=${Date.now()}`)
                    : await fetch('/api/authors');
                const data = await response.json();

                if (data.error) {
                    console.error('Error loading authors:', data.error);
                    return;
                }

                // Store just the login strings, sorted alphabetically
                allAuthors = data.authors.map(a => a.author_login).sort();
                // Validate saved author filter against loaded authors
                if (currentAuthor && !allAuthors.includes(currentAuthor)) {
                    currentAuthor = '';
                    localStorage.setItem('currentAuthor', '');
                    const input = document.getElementById('authorFilterInput');
                    const clearBtn = document.getElementById('authorFilterClearBtn');
                    if (input) input.value = '';
                    if (clearBtn) clearBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading authors:', error);
            }
        }

        function renderRepoList() {
            const repoList = document.getElementById('repoList');
            const allReposCount = document.getElementById('allReposCount');
            const repoCountDisplay = document.getElementById('repoCountDisplay');

            // Filter repos by selected org
            const filteredRepos = currentOrg
                ? repos.filter(r => r.repo_owner === currentOrg)
                : repos;

            const totalPrs = filteredRepos.reduce((sum, repo) => sum + repo.pr_count, 0);
            allReposCount.textContent = `${totalPrs} PR${totalPrs === 1 ? '' : 's'}`;

            // Update the repository count display
            const repoCount = filteredRepos.length;
            repoCountDisplay.textContent = repoCount > 0 ? `(${repoCount})` : '';

            // Update sort button appearance
            const repoSortBtn = document.getElementById('repoSortBtn');
            if (repoSortBtn) {
                repoSortBtn.classList.toggle('text-[#BC0000]', repoSortByPrs);
                repoSortBtn.classList.toggle('dark:text-red-400', repoSortByPrs);
                repoSortBtn.classList.toggle('text-slate-400', !repoSortByPrs);
            }

            // Sort repos by pr_count descending when enabled
            const displayRepos = repoSortByPrs
                ? [...filteredRepos].sort((a, b) => b.pr_count - a.pr_count)
                : filteredRepos;

            while (repoList.children.length > 1) repoList.removeChild(repoList.lastChild);

            const allItem = repoList.querySelector('[data-repo="all"]');
            if (allItem) {
                setRepoItemActiveState(allItem, currentRepo === 'all');
                const nameEl = allItem.querySelector('.repo-name');
                if (nameEl) nameEl.textContent = currentOrg ? `${currentOrg} â€” All Repos` : 'All Repositories';
            }

            // Update mobile dropdown list
            updateMobileDropdown();

            // Update selected repository display for mobile
            updateMobileRepoDisplay();

            displayRepos.forEach(repo => {
                const li = document.createElement('li');
                li.dataset.repo = `${repo.repo_owner}/${repo.repo_name}`;
                setRepoItemActiveState(li, currentRepo === li.dataset.repo);

                const safeAvatarUrl = getRepoAvatarUrl(repo);
                li.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <div class="repo-name text-sm font-semibold text-slate-800 dark:text-slate-200 truncate">
                            ${escapeHtml(repo.repo_name)}
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <img src="${safeAvatarUrl}" alt="${escapeHtml(repo.repo_owner)}" title="${escapeHtml(repo.repo_owner)}/${escapeHtml(repo.repo_name)}" class="h-5 w-5 rounded-full border border-slate-200 dark:border-slate-600 flex-shrink-0" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22%3E%3Crect width=%2220%22 height=%2220%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'">
                                <div class="repo-count text-xs text-slate-500 dark:text-slate-400">
                                    ${repo.pr_count} PR${repo.pr_count === 1 ? '' : 's'} Â· ${repo.analyzed_count || 0} analyzed
                                </div>
                            </div>
                            <div class="flex items-center gap-1">
                                <button
                                    class="add-all-prs-btn text-slate-500 hover:text-[#BC0000] dark:hover:text-red-400 p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                                    title="Import all PRs from this repository"
                                    aria-label="Import all pull requests from this repository"
                                    data-repo-owner="${repo.repo_owner}"
                                    data-repo-name="${repo.repo_name}">
                                    <i class="fas fa-plus text-base text-red-600 hover:text-red-700 transition-colors"></i>
                                </button>
                                <a href="https://github.com/${repo.repo_owner}/${repo.repo_name}/pulls"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="text-slate-500 hover:text-[#BC0000] dark:hover:text-red-400 github-pr-link p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                                title="View Pull Requests on GitHub"
                                onclick="event.stopPropagation();">
                                    <i class="fab fa-github text-base text-red-600 hover:text-red-700 transition-colors"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                `;

                const addAllBtn = li.querySelector('.add-all-prs-btn');
                if (addAllBtn) {
                    addAllBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        addAllPrsFromRepo(repo.repo_owner, repo.repo_name, addAllBtn);
                    });
                }

                li.addEventListener('click', () => {
                    currentPage = 1;
                    currentRepo = li.dataset.repo;
                    localStorage.setItem('currentRepo', currentRepo);
                    document.querySelectorAll('.repo-item').forEach(item => {
                        setRepoItemActiveState(item, item.dataset.repo === currentRepo);
                    });
                    // Move clicked repo to top of list (after "All Repositories")
                    const allItem = repoList.querySelector('[data-repo="all"]');
                    if (allItem) {
                        const nextElement = allItem.nextElementSibling;
                        if (nextElement !== li) {
                            if (nextElement) {
                                repoList.insertBefore(li, nextElement);
                            } else {
                                repoList.appendChild(li);
                            }
                        }
                    }
                    // Scroll to top of page
                    scrollToTop();
                    loadPrs();
                });

                repoList.appendChild(li);
            });

            // On page load, move the selected repo to the top of the list (after "All Repositories")
            if (currentRepo !== 'all') {
                const selectedItem = repoList.querySelector(`[data-repo="${CSS.escape(currentRepo)}"]`);
                const allReposItem = repoList.querySelector('[data-repo="all"]');
                if (selectedItem && allReposItem) {
                    const nextElement = allReposItem.nextElementSibling;
                    if (nextElement !== selectedItem) {
                        repoList.insertBefore(selectedItem, nextElement || null);
                    }
                }
            }
        }

        function updateMobileDropdown(searchTerm = '') {
            const dropdownList = document.getElementById('repoDropdownList');
            if (!dropdownList) return;
            
            dropdownList.innerHTML = '';
            
            // Filter repos based on search term
            const filteredRepos = searchTerm 
                ? repos.filter(r => `${r.repo_owner}/${r.repo_name}`.toLowerCase().includes(searchTerm.toLowerCase()))
                : repos;
            
            // Apply org filter on top of search
            const orgFilteredRepos = currentOrg
                ? filteredRepos.filter(r => r.repo_owner === currentOrg)
                : filteredRepos;

            // Add "All Repositories" option
            const allDiv = document.createElement('div');
            allDiv.className = 'px-3 py-2 text-sm cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600';
            allDiv.dataset.repo = 'all';
            if (currentRepo === 'all') {
                allDiv.classList.add('bg-red-50', 'dark:bg-red-950/30', 'font-semibold');
            }
            const totalPrs = orgFilteredRepos.reduce((sum, repo) => sum + repo.pr_count, 0);
            allDiv.innerHTML = `
                <div class="font-medium text-slate-900 dark:text-slate-100">${currentOrg ? escapeHtml(currentOrg) + ' â€” All Repos' : 'All Repositories'}</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">${totalPrs} PR${totalPrs === 1 ? '' : 's'}</div>
            `;
            allDiv.addEventListener('click', () => selectRepo('all'));
            dropdownList.appendChild(allDiv);
            
            // Add individual repositories
            orgFilteredRepos.forEach(repo => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 text-sm cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600';
                div.dataset.repo = `${repo.repo_owner}/${repo.repo_name}`;
                if (currentRepo === div.dataset.repo) {
                    div.classList.add('bg-red-50', 'dark:bg-red-950/30', 'font-semibold');
                }
                const safeAvatarUrl = getRepoAvatarUrl(repo);
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <img src="${safeAvatarUrl}" alt="${escapeHtml(repo.repo_owner)}" class="h-6 w-6 rounded-full border border-slate-200 dark:border-slate-600 flex-shrink-0" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22%3E%3Crect width=%2224%22 height=%2224%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'">
                        <div>
                            <div class="font-medium text-slate-900 dark:text-slate-100">${escapeHtml(repo.repo_owner)}/${escapeHtml(repo.repo_name)}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">${repo.pr_count} PR${repo.pr_count === 1 ? '' : 's'} Â· ${repo.analyzed_count || 0} analyzed</div>
                        </div>
                    </div>
                `;
                div.addEventListener('click', () => selectRepo(div.dataset.repo));
                dropdownList.appendChild(div);
            });
            
            // Show "No results" if search returns nothing
            if (searchTerm && orgFilteredRepos.length === 0 && !searchTerm.toLowerCase().includes('all')) {
                const noResults = document.createElement('div');
                noResults.className = 'px-3 py-2 text-sm text-slate-500 dark:text-slate-400';
                noResults.textContent = 'No repositories found';
                dropdownList.appendChild(noResults);
            }
        }

        function selectRepo(repoName) {
            currentRepo = repoName;
            currentPage = 1;
            localStorage.setItem('currentRepo', currentRepo);
            updateMobileRepoDisplay();
            closeDropdown();
            scrollToTop();
            loadPrs();
        }

        function updateMobileRepoDisplay() {
            const dropdownText = document.getElementById('repoDropdownText');
            if (dropdownText) {
                if (currentRepo === 'all') {
                    const filteredRepos = currentOrg ? repos.filter(r => r.repo_owner === currentOrg) : repos;
                    const totalPrs = filteredRepos.reduce((sum, repo) => sum + repo.pr_count, 0);
                    const label = currentOrg ? `${currentOrg} â€” All Repos` : 'All Repositories';
                    dropdownText.textContent = `${label} (${totalPrs} PR${totalPrs === 1 ? '' : 's'})`;
                } else {
                    const repo = repos.find(r => `${r.repo_owner}/${r.repo_name}` === currentRepo);
                    if (repo) {
                        dropdownText.textContent = `${repo.repo_owner}/${repo.repo_name} (${repo.pr_count} PR${repo.pr_count === 1 ? '' : 's'})`;
                    } else {
                        dropdownText.textContent = currentRepo;
                    }
                }
            }
        }

        function closeDropdown() {
            const dropdownMenu = document.getElementById('repoDropdownMenu');
            const searchInput = document.getElementById('repoSearchInput');
            if (dropdownMenu) {
                dropdownMenu.classList.add('hidden');
            }
            if (searchInput) {
                searchInput.value = '';
            }
        }

        async function loadPrs(bypassCache = false) {
            const container = document.getElementById('prListContainer');
            // Only show spinner if search is empty to avoid flickering while typing
            if (document.getElementById('prSearchInput').value.trim() === '') {
                container.innerHTML = `
                    <div class="flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white p-8 text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-400">
                        <span class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-slate-300 border-t-slate-500 dark:border-slate-600 dark:border-t-slate-400"></span>
                        Loading PRs...
                    </div>
                `;
            }

            try {
                // Build sort parameters from sortColumns array
                let sortByParam = sortColumns.map(sc => sc.column).join(',');
                let sortDirParam = sortColumns.map(sc => sc.direction).join(',');

                // Build URL with pagination and sorting parameters
                let url;
                if (currentRepo === 'all') {
                    url = `/api/prs?page=${currentPage}&per_page=${perPage}&sort_by=${sortByParam}&sort_dir=${sortDirParam}`;
                    if (currentOrg) url += `&org=${encodeURIComponent(currentOrg)}`;
                } else {
                    url = `/api/prs?repo=${encodeURIComponent(currentRepo)}&page=${currentPage}&per_page=${perPage}&sort_by=${sortByParam}&sort_dir=${sortDirParam}`;
                }
                if (currentAuthor) url += `&author=${encodeURIComponent(currentAuthor)}`;
                if (bypassCache) url += `&_=${Date.now()}`;

                const response = await fetch(url);
                
                // Check if the HTTP request was successful
                if (!response.ok) {
                    let errorMessage = 'Failed to load PRs';
                    if (response.status === 404) {
                        errorMessage = 'API endpoint not found. Please check your configuration.';
                    } else if (response.status === 500) {
                        errorMessage = 'Server error occurred. Please try again later.';
                    } else if (response.status === 503) {
                        errorMessage = 'Service temporarily unavailable. Please try again later.';
                    } else if (response.status >= 400 && response.status < 500) {
                        errorMessage = `Request failed with status ${response.status}. Please try again.`;
                    } else if (response.status >= 500) {
                        errorMessage = `Server error (${response.status}). Please try again later.`;
                    }
                    showContainerError('prListContainer', errorMessage);
                    return;
                }

                const data = await response.json();

                if (data.error) {
                    showContainerError('prListContainer', data.error);
                    return;
                }

                allPrs = data.prs;
                if (data.pagination) {
                    totalPages = data.pagination.total_pages;
                    if (currentPage > totalPages && totalPages > 0) {
                        currentPage = totalPages;
                    }
                }

                // Attach readiness data from localStorage to each PR for display and computed columns
                allPrs.forEach(pr => {
                    // First, try to get readiness data from database (if it exists)
                    if (pr.overall_score !== null && pr.overall_score !== undefined) {
                        pr.ready_score = pr.overall_score;
                        // ci_score and review_score are already in the pr object from database
                        pr.response_score = (pr.response_rate || 0) * 100;
                        pr.feedback_score = pr.total_feedback > 0 ?
                            (pr.responded_feedback / pr.total_feedback) * 100 : 100;

                        // Parse blockers and warnings to get issues count
                        try {
                            const blockers = pr.blockers ? JSON.parse(pr.blockers) : [];
                            const warnings = pr.warnings ? JSON.parse(pr.warnings) : [];
                            pr.issues_count = blockers.length + warnings.length;
                        } catch (e) {
                            pr.issues_count = 0;
                        }
                    } else {
                        // Fall back to localStorage if database doesn't have readiness data
                        const storedData = loadReadinessData(pr.id);
                        if (storedData && storedData.readiness && storedData.reviewHealth) {
                            pr.ready_score = storedData.readiness.overall_score;
                            pr.ci_score = storedData.readiness.ci_score;
                            pr.review_score = storedData.readiness.review_score;
                            pr.response_score = parseFloat(storedData.reviewHealth.response_rate_display.replace('%', ''));
                            pr.feedback_score = storedData.reviewHealth.total_feedback > 0 ?
                                (storedData.reviewHealth.responded_feedback / storedData.reviewHealth.total_feedback) * 100 : 100;
                            pr.issues_count = (storedData.readiness.blockers?.length || 0) + (storedData.readiness.warnings?.length || 0);
                        }
                    }
                });

                // Backend now handles all sorting including computed columns (issues_count)
                // No need for client-side sorting anymore

                // Apply search filter if exists
                const searchTerm = document.getElementById('prSearchInput').value;
                if (searchTerm) {
                    filterPrs(searchTerm);
                } else {
                    renderPrList(allPrs);
                }
            } catch (error) {
                console.error('Error loading PRs:', error);
                
                // Provide more specific error messages
                let errorMessage = 'Failed to load PRs';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    // Network error - common on mobile with poor connectivity
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                } else if (error instanceof SyntaxError) {
                    // JSON parsing error
                    errorMessage = 'Invalid response from server. Please try refreshing the page.';
                } else if (error.message) {
                    // Show the actual error message if available
                    errorMessage = `Error: ${error.message}`;
                }
                
                showContainerError('prListContainer', errorMessage);
            }
        }

        function filterPrs(searchTerm) {
            const term = searchTerm.toLowerCase();
            const filtered = allPrs.filter(pr =>
                (pr.title && pr.title.toLowerCase().includes(term)) ||
                (pr.author_login && pr.author_login.toLowerCase().includes(term)) ||
                (pr.repo_name && pr.repo_name.toLowerCase().includes(term)) ||
                String(pr.pr_number).includes(term)
            );
            renderPrList(filtered);
        }

        /**
         * Check for PR updates by fetching lightweight timestamp data
         * Compare with local cache to detect changes
         */
        async function checkForPrUpdates() {
            if (!autoRefreshEnabled) return;

            try {
                const response = await fetch('/api/prs/updates');
                const data = await response.json();

                if (data.error) {
                    console.error('Error checking for updates:', data.error);
                    return;
                }

                const updates = data.updates || [];
                const changedPrIds = [];
                const newPrIds = [];
                const removedPrIds = [];
                // On the very first check, prUpdateTimestamps is empty.
                // We track this to avoid triggering a reload on the initial population.
                const isFirstCheck = Object.keys(prUpdateTimestamps).length === 0;

                // Detect changes and new PRs
                updates.forEach(update => {
                    const oldTimestamp = prUpdateTimestamps[update.id];
                    if (oldTimestamp === undefined) {
                        // PR not seen before - it's newly added
                        newPrIds.push(update.id);
                    } else if (oldTimestamp !== update.updated_at) {
                        changedPrIds.push(update.id);
                    }
                    prUpdateTimestamps[update.id] = update.updated_at;
                });

                // Detect removals (PRs that were in cache but not in update)
                // Use Set for O(1) lookup instead of O(n) find operation
                const currentPrIds = new Set(updates.map(u => u.id));
                Object.keys(prUpdateTimestamps).forEach(prId => {
                    const prIdNum = parseInt(prId);
                    if (!currentPrIds.has(prIdNum)) {
                        removedPrIds.push(prIdNum);
                        delete prUpdateTimestamps[prId];
                    }
                });

                // Handle removed PRs with animation
                if (removedPrIds.length > 0) {
                    for (const prId of removedPrIds) {
                        await removePrWithAnimation(prId);
                    }

                    // If all visible PRs were removed, reload from page 1 to show
                    // any remaining PRs (e.g. from other pages or repositories)
                    // rather than incorrectly showing "No PRs Added Yet"
                    if (allPrs.length === 0) {
                        currentPage = 1;
                        await loadPrs(true);
                        await loadRepos(true);
                        return;
                    }
                }

                // Update only the changed rows in-place rather than reloading the full list
                if (changedPrIds.length > 0) {
                    console.log('PR updates detected, updating rows:', changedPrIds);
                    for (const prId of changedPrIds) {
                        await fetchAndUpdatePrRow(prId);
                    }
                }

                // New PRs require a full reload so they appear in the correct sorted position
                if (!isFirstCheck && newPrIds.length > 0) {
                    console.log('New PRs detected, reloading list:', newPrIds);
                    await loadPrs(true);
                    await loadRepos(true);
                    return;
                }

                // Safety net: if the view is empty but the DB has PRs and no changes/removals
                // were detected, the view may be stuck in an empty state due to a prior bug.
                // Trigger a reload (skipped on the first check to avoid conflicting with
                // the initial loadPrs() call that runs concurrently at page startup).
                if (!isFirstCheck && allPrs.length === 0 && updates.length > 0 &&
                        changedPrIds.length === 0 && removedPrIds.length === 0) {
                    await loadPrs(true);
                }

                // Update repo counts if there were any changes or removals
                if (changedPrIds.length > 0 || removedPrIds.length > 0) {
                    await loadRepos(true);
                }
            } catch (error) {
                console.error('Error checking for PR updates:', error);
            }
        }

        /**
         * Fetch a single PR's stored data and update its row in-place.
         * Used by checkForPrUpdates to avoid full list reloads.
         */
        async function fetchAndUpdatePrRow(prId) {
            try {
                const response = await fetch(`/api/prs/${prId}`);
                if (!response.ok) {
                    console.warn(`Failed to fetch PR ${prId}: HTTP ${response.status}`);
                    return;
                }
                const data = await response.json();
                if (data.error || !data.pr) return;
                updateSinglePrRow(prId, data.pr);
            } catch (error) {
                console.error(`Error fetching PR ${prId}:`, error);
            }
        }

        /**
         * Remove a PR from the UI with animation
         */
        async function removePrWithAnimation(prId) {
            // Remove from allPrs array
            const prIndex = allPrs.findIndex(pr => pr.id === prId);
            if (prIndex !== -1) {
                allPrs.splice(prIndex, 1);
            }

            // Get the row element
            const row = document.getElementById(`pr-row-${prId}`);
            if (row) {
                // Add fade-out animation
                row.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                row.style.opacity = '0';
                row.style.transform = 'translateX(20px)';

                // Remove the row after animation completes
                await new Promise(resolve => setTimeout(resolve, 300));
                row.remove();
            }
        }

        /**
         * Start auto-refresh polling
         */
        async function startAutoRefresh() {
            if (autoRefreshInterval) return; // Already running

            autoRefreshEnabled = true;
            localStorage.setItem('autoRefreshEnabled', 'true');

            // Initial check (await to handle errors properly)
            await checkForPrUpdates();

            // Set up interval
            autoRefreshInterval = setInterval(checkForPrUpdates, AUTO_REFRESH_INTERVAL);

            // Update UI
            updateAutoRefreshUI();
        }

        /**
         * Stop auto-refresh polling
         */
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }

            autoRefreshEnabled = false;
            localStorage.setItem('autoRefreshEnabled', 'false');

            // Update UI
            updateAutoRefreshUI();
        }

        /**
         * Toggle auto-refresh on/off
         */
        function toggleAutoRefresh() {
            if (autoRefreshEnabled) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        }

        /**
         * Update the auto-refresh button appearance
         */
        function updateAutoRefreshUI() {
            const buttons = document.querySelectorAll('#autoRefreshToggle');
            const icons = document.querySelectorAll('#autoRefreshIcon');

            if (autoRefreshEnabled) {
                buttons.forEach(button => {
                    button.classList.add('text-green-600', 'dark:text-green-400');
                    button.classList.remove('text-slate-500', 'dark:text-slate-400');
                    button.title = 'Auto-refresh enabled (click to disable)';
                });
                icons.forEach(icon => {
                    icon.classList.add('fa-spin');
                });
            } else {
                buttons.forEach(button => {
                    button.classList.remove('text-green-600', 'dark:text-green-400');
                    button.classList.add('text-slate-500', 'dark:text-slate-400');
                    button.title = 'Auto-refresh disabled (click to enable)';
                });
                icons.forEach(icon => {
                    icon.classList.remove('fa-spin');
                });
            }
        }

        /**
         * Show raw data modal with PR data
         */
        function showRawDataModal(prId) {
            const modal = document.getElementById('rawDataModal');
            const content = document.getElementById('rawDataContent').querySelector('code');
            
            // Find the specific PR data
            const prData = allPrs.find(pr => pr.id === prId);
            
            if (!prData) {
                console.error('PR not found:', prId);
                return;
            }
            
            // Format as pretty JSON
            content.textContent = JSON.stringify(prData, null, 2);
            
            // Show modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        /**
         * Hide raw data modal
         */
        function hideRawDataModal() {
            const modal = document.getElementById('rawDataModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        /**
         * Copy raw data to clipboard
         */
        async function copyRawDataToClipboard() {
            const content = document.getElementById('rawDataContent').querySelector('code');
            try {
                await navigator.clipboard.writeText(content.textContent);
                const btn = document.getElementById('copyRawDataBtn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-red-600', 'hover:bg-red-700');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                showError('Failed to copy to clipboard');
            }
        }

        /**
         * Pause auto-refresh when tab is not visible (optimization)
         */
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Clear interval when tab is hidden
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            } else {
                // Resume polling when tab becomes visible (only if auto-refresh is enabled)
                if (autoRefreshEnabled && !autoRefreshInterval) {
                    autoRefreshInterval = setInterval(checkForPrUpdates, AUTO_REFRESH_INTERVAL);
                    checkForPrUpdates(); // Check immediately on tab becoming visible
                }
            }
        });

        function renderPrList(prsToRender) {
            const container = document.getElementById('prListContainer');
            // Use the passed filtered list OR fallback to allPrs
            const prs = prsToRender || allPrs || [];

            if (prs.length === 0) {
                const isFiltered = document.getElementById('prSearchInput').value.trim() !== '';
                const emptyTitle = isFiltered ? "No PRs Match" : "No PRs Added Yet";
                container.innerHTML = `
                    <div class="rounded-xl border border-dashed border-slate-300 bg-white p-10 text-center dark:border-slate-600 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">${emptyTitle}</h3>
                        <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Add a GitHub PR URL above to start tracking</p>
                    </div>
                `;
                return;
            }

            const getSortIcon = (column) => {
                // Find the column in the sort columns array
                const sortIndex = sortColumns.findIndex(sc => sc.column === column);

                if (sortIndex >= 0) {
                    const sortCol = sortColumns[sortIndex];
                    const direction = sortCol.direction;
                    const isPrimary = sortIndex === 0;

                    if (isPrimary) {
                        // Primary sort - red color, normal size
                        const icon = direction === 'asc'
                            ? '<i class="fas fa-sort-up text-[#BC0000] dark:text-red-400 ml-1"></i>'
                            : '<i class="fas fa-sort-down text-[#BC0000] dark:text-red-400 ml-1"></i>';
                        return icon;
                    } else {
                        // Secondary or tertiary sort - gray color, smaller size with number
                        const number = sortIndex + 1; // 1-indexed for display
                        const icon = direction === 'asc'
                            ? '<i class="fas fa-sort-up text-slate-500 dark:text-slate-400 ml-1" style="font-size: 0.75em;"></i>'
                            : '<i class="fas fa-sort-down text-slate-500 dark:text-slate-400 ml-1" style="font-size: 0.75em;"></i>';
                        return `<sup class="text-xs text-slate-500 dark:text-slate-400 align-baseline leading-none">${number}</sup>${icon}`;
                    }
                }

                // Not in sort list
                return '<i class="fas fa-sort text-slate-400 ml-1"></i>';
            };

            const refreshApiCalls = Math.ceil(allPrs.length / 50);
            // Each readiness check fetches at least 4 GitHub endpoints in parallel:
            // commits, reviews, review_comments, issue_comments
            // NOTE: This is a lower-bound estimate; pagination can require additional API calls per PR.

            container.innerHTML = `
                <div class="mb-2 flex gap-2">
                    <button 
                        id="clearSortBtn" 
                        class="rounded px-2 py-1 text-xs font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600"
                        title="Clear all sorting and reset to default (Ready Score)">
                        <i class="fas fa-times-circle"></i> Clear Sort
                    </button>
                    <button 
                        id="sortByReadinessBtn" 
                        class="rounded px-2 py-1 text-xs font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600"
                        title="Sort by Readiness Score (Ready column)">
                        <i class="fas fa-sort-amount-down"></i> Sort by Readiness
                    </button>
                    <button 
                        id="refreshPrsBtn" 
                        class="rounded px-2 py-1 text-xs font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600"
                        title="Refresh essential PR data from GitHub API (uses GraphQL batch: 1 call per 50 PRs)">
                        <i class="fas fa-sync-alt"></i> Refresh All Essential <span class="font-semibold text-slate-500 dark:text-slate-400">(${refreshApiCalls} API call${refreshApiCalls !== 1 ? 's' : ''})</span>
                    </button>
                    <button 
                        id="analyzeAllBtn" 
                        class="rounded px-2 py-1 text-xs font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600"
                        title="Analyze readiness for all PRs (at least 4 GitHub API calls per PR: commits, reviews, review comments, issue comments; more if paginated)">
                        <i class="fas fa-chart-bar"></i> Analyze All <span class="font-semibold text-slate-500 dark:text-slate-400">(${allPrs.length} Ã— 4+ API calls)</span>
                    </button>
                </div>
                <div class="rounded-xl border border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800" style="overflow-x: auto;">
                    <table class="w-full text-left text-sm" style="min-width: 1920px;">
                        <thead class="border-b border-slate-200 bg-slate-50 text-xs font-semibold uppercase tracking-wider text-slate-700 dark:border-slate-700 dark:bg-slate-900/50 dark:text-slate-300">
                            <tr>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="author_login" style="min-width: 100px;" title="Click to sort by Author. Shift+Click to add to sort columns.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (user.login field)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Author</span> ${getSortIcon('author_login')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="title" style="min-width: 200px;" title="Click to sort by PR Title. Shift+Click to add to sort columns.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (title field)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">PR Title</span> ${getSortIcon('title')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="repo_owner" style="min-width: 140px;" title="Click to sort by Repository. Shift+Click to add to sort columns.&#10;Stored in database (extracted from PR URL when added)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Repository</span> ${getSortIcon('repo_owner')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="review_status" style="min-width: 90px;" title="Click to sort by Review. Shift+Click to add to sort columns.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number}/reviews (latest state per reviewer)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Review</span> ${getSortIcon('review_status')}
                                    </div>
                                </th>
                                <th class="px-2 py-3" style="min-width: 90px;" title="Reviewer avatars grouped by review state (Approved, Changes Requested, Commented, Pending)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Approvals</span>
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="mergeable_state" style="min-width: 90px;" title="Click to sort by Mergeable. Shift+Click to add to sort columns.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (mergeable_state field)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Mergeable</span> ${getSortIcon('mergeable_state')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="files_changed" style="min-width: 60px;" title="Click to sort by Files. Shift+Click to add to sort columns.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number}/files (count of files)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Files</span> ${getSortIcon('files_changed')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="commits_count" style="min-width: 70px;" title="Click to sort by Commits. Shift+Click to add to sort columns.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (commits field)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Commits</span> ${getSortIcon('commits_count')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="behind_by" style="min-width: 70px;" title="Click to sort by Behind. Shift+Click to add to sort columns.&#10;API: GET /repos/{owner}/{repo}/compare/{base}...{head} (behind_by field) - Shows commits behind base branch">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Behind</span> ${getSortIcon('behind_by')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="checks_passed" style="min-width: 90px;" title="Click to sort by Checks. Shift+Click to add to sort columns.&#10;API: GET /repos/{owner}/{repo}/commits/{sha}/check-runs (conclusion field)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Checks</span> ${getSortIcon('checks_passed')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="open_conversations_count" style="min-width: 70px;" title="Click to sort by Conversations. Shift+Click to set as secondary sort.&#10;Open (unresolved) review conversations - Fetched via GraphQL API reviewThreads">
                                    <div class="flex items-center justify-center gap-1 min-w-0">
                                        <span class="truncate">Convos</span> ${getSortIcon('open_conversations_count')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="ready" style="min-width: 60px;" title="Click to sort by Merge Ready Status (âœ…/âŒ). Shift+Click to add to sort columns.&#10;Merge Ready Flag - Indicates if PR is ready to merge (no blockers, CI passing, reviews approved)">
                                    <div class="flex items-center justify-center gap-1 min-w-0">
                                        <span class="truncate">Status</span> ${getSortIcon('ready')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="ready_score" style="min-width: 60px;" title="Click to sort by Ready Score (0-100%). Shift+Click to add to sort columns.&#10;Overall Readiness Score - Calculated: (CI Score * 45%) + (Review Score * 55%)">
                                    <div class="flex items-center justify-center gap-1 min-w-0">
                                        <span class="truncate">Score</span> ${getSortIcon('ready_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="ci_score" style="min-width: 50px;" title="Click to sort by CI. Shift+Click to add to sort columns.&#10;CI Score - Calculated from check-runs API based on pass/fail/skip counts">
                                    <div class="flex items-center justify-center gap-1 min-w-0">
                                        <span class="truncate">CI</span> ${getSortIcon('ci_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="review_score" style="min-width: 60px;" title="Click to sort by Review. Shift+Click to add to sort columns.&#10;Review Score - Calculated from timeline analysis (commits, reviews, comments)">
                                    <div class="flex items-center justify-center gap-1 min-w-0">
                                        <span class="truncate">Review</span> ${getSortIcon('review_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="response_score" style="min-width: 70px;" title="Click to sort by Response. Shift+Click to add to sort columns.&#10;Response Rate - Calculated from timeline analysis using GET /repos/{owner}/{repo}/pulls/{pr_number}/commits and GET /repos/{owner}/{repo}/issues/{pr_number}/comments">
                                    <div class="flex items-center justify-center gap-1 min-w-0">
                                        <span class="truncate">Response</span> ${getSortIcon('response_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="feedback_score" style="min-width: 80px;" title="Click to sort by Feedback. Shift+Click to add to sort columns.&#10;Feedback Responded/Total - Calculated from GET /repos/{owner}/{repo}/pulls/{pr_number}/comments (review comments on diff)">
                                    <div class="flex items-center justify-center gap-1 min-w-0">
                                        <span class="truncate">Feedback</span> ${getSortIcon('feedback_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="issues_count" style="min-width: 200px;" title="Click to sort by Issues. Shift+Click to add to sort columns.&#10;Blockers, Warnings, and Recommendations - Calculated from readiness analysis combining all API data">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <span class="truncate">Issues</span> ${getSortIcon('issues_count')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="last_updated_at" style="min-width: 90px;" title="Click to sort by PR last updated time. Shift+Click to add to sort columns.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (updated_at field)">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <i class="fas fa-clock text-slate-400 dark:text-slate-500 flex-shrink-0"></i>
                                        <span class="truncate">PR Updated</span> ${getSortIcon('last_updated_at')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="last_refreshed_at" style="min-width: 90px;" title="Click to sort by last data refresh time. Shift+Click to add to sort columns.&#10;Timestamp of last data refresh from GitHub">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <i class="fas fa-sync-alt text-slate-400 dark:text-slate-500 flex-shrink-0"></i>
                                        <span class="truncate">Refreshed</span> ${getSortIcon('last_refreshed_at')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="readiness_computed_at" style="min-width: 90px;" title="Click to sort by last readiness analysis time. Shift+Click to add to sort columns.&#10;Timestamp of last readiness analysis">
                                    <div class="flex items-center gap-1 min-w-0">
                                        <i class="fas fa-chart-bar text-slate-400 dark:text-slate-500 flex-shrink-0"></i>
                                        <span class="truncate">Analyzed</span> ${getSortIcon('readiness_computed_at')}
                                    </div>
                                </th>
                                <th class="px-2 py-3 text-center" style="min-width: 180px;" title="UI actions: Refresh PR data, Check Readiness, Remove from tracking">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700" id="prTableBody">
                        </tbody>
                    </table>
                </div>
            `;

            const tbody = document.getElementById('prTableBody');
            prs.forEach(pr => {
                const row = createPrRow(pr);
                tbody.appendChild(row);

                // Load and display readiness data from database or localStorage if available
                let readiness = null;
                let reviewHealth = null;

                // First, try to get readiness data from database (if it exists)
                if (pr.overall_score !== null && pr.overall_score !== undefined) {
                    // Parse JSON fields from database
                    try {
                        const blockers = pr.blockers ? JSON.parse(pr.blockers) : [];
                        const warnings = pr.warnings ? JSON.parse(pr.warnings) : [];
                        const recommendations = pr.recommendations ? JSON.parse(pr.recommendations) : [];
                        const stale_feedback = pr.stale_feedback ? JSON.parse(pr.stale_feedback) : [];

                        readiness = {
                            overall_score: pr.overall_score,
                            overall_score_display: `${pr.overall_score}%`,
                            ci_score: pr.ci_score,
                            ci_score_display: `${pr.ci_score}%`,
                            review_score: pr.review_score,
                            review_score_display: `${pr.review_score}%`,
                            classification: pr.classification,
                            merge_ready: pr.merge_ready === 1,
                            blockers: blockers,
                            warnings: warnings,
                            recommendations: recommendations
                        };

                        reviewHealth = {
                            classification: pr.review_health_classification,
                            score: pr.review_health_score,
                            score_display: `${pr.review_health_score || 0}%`,
                            response_rate: pr.response_rate || 0,
                            response_rate_display: `${Math.round((pr.response_rate || 0) * 100)}%`,
                            total_feedback: pr.total_feedback || 0,
                            responded_feedback: pr.responded_feedback || 0,
                            stale_feedback_count: pr.stale_feedback_count || 0,
                            stale_feedback: stale_feedback
                        };
                    } catch (e) {
                        console.error('Error parsing readiness data from database:', e);
                    }
                }

                // Fall back to localStorage if database doesn't have data
                if (!readiness || !reviewHealth) {
                    const storedData = loadReadinessData(pr.id);
                    if (storedData && storedData.readiness && storedData.reviewHealth) {
                        readiness = storedData.readiness;
                        reviewHealth = storedData.reviewHealth;
                    }
                }

                // Display the readiness data if available
                if (readiness && reviewHealth) {
                    updateInlineCells(pr.id, readiness, reviewHealth);
                    // Update button to show it was analyzed
                    const updateBtn = row.querySelector('.update-btn');
                    if (updateBtn) {
                        updateBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Analyzed';
                    }
                }
            });

            document.querySelectorAll('.update-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const prId = e.currentTarget.dataset.prId;
                    await updatePr(prId, e.currentTarget);
                });
            });
            
            document.querySelectorAll('.quick-refresh-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const prId = parseInt(e.currentTarget.dataset.prId, 10);
                    await quickRefreshPr(prId, e.currentTarget);
                });
            });
            
            document.querySelectorAll('.view-raw-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const prId = parseInt(e.currentTarget.dataset.prId, 10);
                    showRawDataModal(prId);
                });
            });
            
            if (document.getElementById('prSearchInput').value.trim() === '') {
                renderPagination();
            }
        }

        function renderPagination() {
            const container = document.getElementById('prListContainer');

            // Remove existing pagination if present
            const existing = container.querySelector('.pagination-wrapper');
            if (existing) existing.remove();

            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-wrapper flex items-center justify-between mt-4';

            paginationDiv.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="text-sm text-slate-600 dark:text-slate-400">
                        Page <span class="font-semibold">${currentPage}</span> of <span class="font-semibold">${totalPages}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                        <label for="pageSizeSelect" class="whitespace-nowrap">Items per page:</label>
                        <select 
                            id="pageSizeSelect" 
                            class="px-2 py-1 rounded-lg border border-slate-300 bg-white text-slate-900 text-sm 
                                   dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 
                                   focus:outline-none focus:ring-2 focus:ring-red-500 dark:focus:ring-red-400">
                            <option value="10" ${perPage === 10 ? 'selected' : ''}>10</option>
                            <option value="25" ${perPage === 25 ? 'selected' : ''}>25</option>
                            <option value="30" ${perPage === 30 ? 'selected' : ''}>30</option>
                            <option value="50" ${perPage === 50 ? 'selected' : ''}>50</option>
                            <option value="100" ${perPage === 100 ? 'selected' : ''}>100</option>
                            <option value="250" ${perPage === 250 ? 'selected' : ''}>250</option>
                            <option value="500" ${perPage === 500 ? 'selected' : ''}>500</option>
                            <option value="1000" ${perPage === 1000 ? 'selected' : ''}>1000</option>
                        </select>
                    </div>
                </div>
            <div class="flex gap-2">
                <button 
                    ${currentPage === 1 ? 'disabled' : ''} 
                    class="px-4 py-2 rounded-lg border text-sm font-semibold transition-all
                           ${currentPage === 1
                    ? 'bg-slate-200 text-slate-400 cursor-not-allowed dark:bg-slate-700 dark:text-slate-500'
                    : 'bg-white hover:bg-red-50 border-slate-300 hover:border-red-300 dark:bg-slate-800 dark:hover:bg-slate-700'}"
                    id="prevPageBtn"> â† Previous
                </button>

                <button 
                    ${currentPage === totalPages ? 'disabled' : ''} 
                    class="px-4 py-2 rounded-lg border text-sm font-semibold transition-all
                            ${currentPage === totalPages
                    ? 'bg-slate-200 text-slate-400 cursor-not-allowed dark:bg-slate-700 dark:text-slate-500'
                    : 'bg-white hover:bg-red-50 border-slate-300 hover:border-red-300 dark:bg-slate-800 dark:hover:bg-slate-700'}"
                    id="nextPageBtn"> Next â†’
                </button>
            </div>
        `;

            container.appendChild(paginationDiv);

            document.getElementById('prevPageBtn')?.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadPrs();
                }
            });
            document.getElementById('nextPageBtn')?.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadPrs();
                }
            });
            
            // Handle page size change
            document.getElementById('pageSizeSelect')?.addEventListener('change', (e) => {
                const newPerPage = parseInt(e.target.value, 10);
                
                // Validate the new page size to guard against DOM manipulation
                if (Number.isNaN(newPerPage) || newPerPage < 10 || newPerPage > 1000) {
                    // Revert the select value to the current perPage if invalid
                    e.target.value = perPage.toString();
                    return;
                }
                
                if (newPerPage !== perPage) {
                    perPage = newPerPage;
                    localStorage.setItem('perPage', perPage.toString());
                    currentPage = 1; // Reset to first page when changing page size
                    loadPrs();
                }
            });
        }

        function createPrRow(pr) {
            let stateBadge = '';
            if (pr.is_merged) {
                stateBadge = '<span class="inline-flex rounded-full border border-[#f5b0b0] bg-[#fff1f1] px-2 py-0.5 text-xs font-semibold text-[#BC0000] dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">Merged</span>';
            } else if (pr.is_draft == 1) {
                stateBadge = '<span class="inline-flex rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-xs font-semibold text-slate-700 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-400">Draft</span>';
            } else if (pr.state === 'open') {
                stateBadge = '<span class="inline-flex rounded-full border border-emerald-200 bg-emerald-50 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400">Open</span>';
            } else {
                stateBadge = '<span class="inline-flex rounded-full border border-red-200 bg-red-50 px-2 py-0.5 text-xs font-semibold text-red-700 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">Closed</span>';
            }

            let reviewBadge = '';
            if (pr.review_status === 'approved') {
                reviewBadge = '<span class="inline-flex rounded-full border border-emerald-200 bg-emerald-50 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400">Approved</span>';
            } else if (pr.review_status === 'changes_requested') {
                reviewBadge = '<span class="inline-flex rounded-full border border-red-200 bg-red-50 px-2 py-0.5 text-xs font-semibold text-red-700 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">Changes</span>';
            } else if (pr.review_status === 'pending') {
                reviewBadge = '<span class="inline-flex rounded-full border border-amber-200 bg-amber-50 px-2 py-0.5 text-xs font-semibold text-amber-700 dark:border-amber-900 dark:bg-amber-950/30 dark:text-amber-400">Pending</span>';
            } else {
                reviewBadge = '<span class="inline-flex rounded-full border border-slate-200 bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:bg-slate-700 dark:text-slate-300">None</span>';
            }

            let mergeableText = pr.mergeable_state || 'unknown';
            if (mergeableText === 'clean') mergeableText = 'Ready';
            else if (mergeableText === 'dirty') mergeableText = 'Conflicts';
            else if (mergeableText === 'blocked') mergeableText = 'Blocked';
            else if (mergeableText === 'unstable') mergeableText = 'Unstable';

            const avatarUrl = pr.author_avatar &&
                (pr.author_avatar.startsWith('https://avatars.githubusercontent.com/') || pr.author_avatar.startsWith('https://github.com/'))
                ? pr.author_avatar
                : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="32" height="32"%3E%3Crect width="32" height="32" fill="%23E2E8F0"/%3E%3C/svg%3E';

            const repoOwnerAvatarUrl = pr.repo_owner_avatar &&
                (pr.repo_owner_avatar.startsWith('https://avatars.githubusercontent.com/') || pr.repo_owner_avatar.startsWith('https://github.com/'))
                ? pr.repo_owner_avatar
                : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="32" height="32"%3E%3Crect width="32" height="32" fill="%23E2E8F0"/%3E%3C/svg%3E';

            // Truncate title to first 20 characters
            const truncatedTitle = pr.title && pr.title.length > 20 ? pr.title.substring(0, 20) + '...' : pr.title;

            const row = document.createElement('tr');
            row.className = 'hover:bg-slate-50 dark:hover:bg-slate-900/50';
            row.id = `pr-row-${pr.id}`;
            row.innerHTML = `
                <td class="px-2 py-3">
                    <div class="flex items-center gap-2 min-w-0">
                        ${renderAuthorWithChecks(avatarUrl, pr.author_login, pr.checks_passed, pr.checks_failed, pr.checks_skipped, repoOwnerAvatarUrl, pr.repo_owner)}
                        <span class="text-slate-600 dark:text-slate-400 text-xs truncate">${escapeHtml(pr.author_login)}</span>
                    </div>
                </td>
                <td class="px-2 py-3">
                    <div class="flex items-center gap-2 min-w-0">
                        <a href="${escapeHtml(pr.pr_url)}" target="_blank" rel="noopener noreferrer" class="font-medium text-slate-900 hover:text-[#BC0000] dark:text-slate-100 dark:hover:text-red-400 truncate text-xs" title="${escapeHtml(pr.title)}">${escapeHtml(truncatedTitle)}</a>
                    </div>
                </td>
                <td class="px-2 py-3 text-slate-600 dark:text-slate-400">
                    <div class="truncate text-xs">${escapeHtml(pr.repo_owner)}/${escapeHtml(pr.repo_name)}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-500">#${pr.pr_number}</div>
                </td>
                <td class="px-2 py-3">${reviewBadge}</td>
                <td class="px-2 py-3">${renderReviewerAvatars(pr.reviewers_json)}</td>
                <td class="px-2 py-3 text-slate-700 dark:text-slate-300 text-xs truncate">${escapeHtml(mergeableText)}</td>
                <td class="px-2 py-3 text-center text-slate-700 dark:text-slate-300 text-xs">${pr.files_changed}</td>
                <td class="px-2 py-3 text-center text-slate-700 dark:text-slate-300 text-xs">${pr.commits_count || 0}</td>
                <td class="px-2 py-3 text-center text-slate-700 dark:text-slate-300 text-xs">
                    ${pr.behind_by > 0 ? `<span class="inline-flex items-center gap-1 rounded border border-amber-200 bg-amber-50 px-1.5 py-0.5 text-amber-700 dark:border-amber-900 dark:bg-amber-950/30 dark:text-amber-400" title="This PR is ${pr.behind_by} commit${pr.behind_by !== 1 ? 's' : ''} behind the base branch">
                        <i class="fas fa-exclamation-triangle"></i>${pr.behind_by}
                    </span>` : `<span class="inline-flex items-center gap-1 rounded border border-emerald-200 bg-emerald-50 px-1.5 py-0.5 text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400" title="This PR is up to date with the base branch">
                        <i class="fas fa-check"></i>
                    </span>`}
                </td>
                <td class="px-2 py-3">
                    <div class="flex flex-wrap gap-1 text-xs">
                        <span class="inline-flex items-center gap-1 rounded border border-emerald-200 bg-emerald-50 px-1.5 py-0.5 text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400">
                            <i class="fas fa-check-circle"></i>${pr.checks_passed}
                        </span>
                        ${pr.checks_failed > 0 ? `<a href="https://github.com/${escapeHtml(pr.repo_owner)}/${escapeHtml(pr.repo_name)}/pull/${escapeHtml(String(pr.pr_number))}/checks" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 rounded border border-red-200 bg-red-50 px-1.5 py-0.5 text-red-700 hover:border-red-300 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">
                            <i class="fas fa-times-circle"></i>${escapeHtml(String(pr.checks_failed))}
                        </a>` : `<span class="inline-flex items-center gap-1 rounded border border-red-200 bg-red-50 px-1.5 py-0.5 text-red-700 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">
                            <i class="fas fa-times-circle"></i>${pr.checks_failed}
                        </span>`}
                        ${pr.checks_skipped > 0 ? `<span class="inline-flex items-center gap-1 rounded border border-slate-200 bg-slate-100 px-1.5 py-0.5 text-slate-600 dark:border-slate-700 dark:bg-slate-700 dark:text-slate-400">
                            <i class="fas fa-minus-circle"></i>${pr.checks_skipped}
                        </span>` : ''}
                    </div>
                </td>
                <td class="px-2 py-3 text-center text-slate-700 dark:text-slate-300 text-xs">
                    ${pr.open_conversations_count > 0 ? `<span class="inline-flex items-center gap-1 rounded border border-amber-200 bg-amber-50 px-1.5 py-0.5 text-amber-700 dark:border-amber-900 dark:bg-amber-950/30 dark:text-amber-400" title="${pr.open_conversations_count} unresolved conversation${pr.open_conversations_count !== 1 ? 's' : ''}">
                        <i class="fas fa-comment-dots"></i>${pr.open_conversations_count}
                    </span>` : `<span class="inline-flex items-center gap-1 rounded border border-emerald-200 bg-emerald-50 px-1.5 py-0.5 text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400" title="No unresolved conversations">
                        <i class="fas fa-check"></i>0
                    </span>`}
                </td>
                <td class="px-2 py-3 text-center" id="readiness-status-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-score-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-ci-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-review-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-response-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-feedback-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3" id="readiness-issues-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-xs text-slate-600 dark:text-slate-400 truncate">
                    <span class="inline-flex items-center gap-1"><i class="fas fa-clock text-slate-400 dark:text-slate-500"></i>${escapeHtml(timeAgo(pr.last_updated_at))}</span>
                </td>
                <td class="px-2 py-3 text-xs text-slate-600 dark:text-slate-400 truncate">
                    <span class="inline-flex items-center gap-1"><i class="fas fa-sync-alt text-slate-400 dark:text-slate-500"></i>${pr.last_refreshed_at ? escapeHtml(timeAgo(pr.last_refreshed_at)) : '<span class="text-slate-400">-</span>'}</span>
                </td>
                <td class="px-2 py-3 text-xs text-slate-600 dark:text-slate-400 truncate">
                    <span class="inline-flex items-center gap-1"><i class="fas fa-chart-bar text-slate-400 dark:text-slate-500"></i>${pr.readiness_computed_at ? escapeHtml(timeAgo(pr.readiness_computed_at)) : '<span class="text-slate-400">-</span>'}</span>
                </td>
                <td class="px-2 py-3 text-center">
                    <div class="flex items-center justify-center gap-1">
                        <button class="quick-refresh-btn rounded-md border border-slate-400 bg-white px-2 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-50 dark:border-slate-500 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600" data-pr-id="${pr.id}" title="Quick refresh: update essential PR data only (no readiness analysis)" aria-label="Quick refresh pull request">
                            <i class="fas fa-bolt"></i>
                        </button>
                        <button class="update-btn inline-flex items-center justify-center rounded-md border border-[#E10000] bg-white px-3 py-2 text-xs font-semibold text-[#E10000] hover:bg-[#fff1f1] dark:border-red-700 dark:bg-slate-700 dark:text-red-400 dark:hover:bg-red-950/30" style="min-width:6.5rem;" data-pr-id="${pr.id}" title="Refresh PR data and analyze readiness">
                            <i class="fas fa-chart-bar mr-1"></i>Analyze
                        </button>
                        <button class="view-raw-btn rounded-md border border-slate-300 bg-white px-2 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600" data-pr-id="${pr.id}" title="View raw PR data">
                            <i class="fas fa-database"></i>
                        </button>
                    </div>
                </td>
            `;

            // Add click handler to highlight the row when clicked
            row.addEventListener('click', (e) => {
                // Don't trigger row selection if clicking on the update button or links
                if (e.target.closest('button') || e.target.closest('a')) {
                    return;
                }

                // Remove active class from previously selected row
                if (activePrId) {
                    const previousActiveRow = document.getElementById(`pr-row-${activePrId}`);
                    if (previousActiveRow) {
                        previousActiveRow.classList.remove('pr-row-active');
                    }
                }

                // Set new active row
                activePrId = pr.id;
                row.classList.add('pr-row-active');
            });

            // If this is the currently active PR, apply the active class
            if (activePrId === pr.id) {
                row.classList.add('pr-row-active');
            }

            return row;
        }

        function updateSinglePrRow(prId, prData) {
            // Find and update the PR in allPrs array
            const prIndex = allPrs.findIndex(pr => pr.id === prId);
            if (prIndex !== -1) {
                // Preserve the id from the existing PR
                allPrs[prIndex] = { ...prData, id: prId };
            }

            // Get the existing row
            const existingRow = document.getElementById(`pr-row-${prId}`);
            if (!existingRow) return;

            // Create new row with updated data
            const newRow = createPrRow({ ...prData, id: prId });

            // Replace the old row with the new one (with glide-in animation)
            newRow.classList.add('pr-row-glide-in');
            existingRow.replaceWith(newRow);

            // Restore readiness data so analysis cells are not lost after a quick refresh.
            // Prefer fields already in prData (full DB row), fall back to localStorage.
            let readiness = null;
            let reviewHealth = null;
            if (prData.overall_score != null) {
                try {
                    readiness = {
                        overall_score: prData.overall_score,
                        overall_score_display: `${prData.overall_score}%`,
                        ci_score: prData.ci_score,
                        ci_score_display: `${prData.ci_score}%`,
                        review_score: prData.review_score,
                        review_score_display: `${prData.review_score}%`,
                        classification: prData.classification,
                        merge_ready: prData.merge_ready === 1,
                        blockers: prData.blockers ? JSON.parse(prData.blockers) : [],
                        warnings: prData.warnings ? JSON.parse(prData.warnings) : [],
                        recommendations: prData.recommendations ? JSON.parse(prData.recommendations) : []
                    };
                    reviewHealth = {
                        classification: prData.review_health_classification,
                        score: prData.review_health_score,
                        score_display: `${prData.review_health_score || 0}%`,
                        response_rate: prData.response_rate || 0,
                        response_rate_display: `${Math.round((prData.response_rate || 0) * 100)}%`,
                        total_feedback: prData.total_feedback || 0,
                        responded_feedback: prData.responded_feedback || 0,
                        stale_feedback_count: prData.stale_feedback_count || 0,
                        stale_feedback: prData.stale_feedback ? JSON.parse(prData.stale_feedback) : []
                    };
                } catch (e) {
                    readiness = null;
                    reviewHealth = null;
                }
            }
            if (!readiness || !reviewHealth) {
                const stored = loadReadinessData(prId);
                if (stored && stored.readiness && stored.reviewHealth) {
                    readiness = stored.readiness;
                    reviewHealth = stored.reviewHealth;
                }
            }
            if (readiness && reviewHealth) {
                updateInlineCells(prId, readiness, reviewHealth);
                const updateBtn = newRow.querySelector('.update-btn');
                if (updateBtn) {
                    updateBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Analyzed';
                }
            }

            // Re-attach the click event listener to the new button
            const updateBtn = newRow.querySelector('.update-btn');
            if (updateBtn) {
                updateBtn.addEventListener('click', async (e) => {
                    await updatePr(prId, e.currentTarget);
                });
            }
            
            // Re-attach the click event listener to the quick refresh button
            const quickRefreshBtn = newRow.querySelector('.quick-refresh-btn');
            if (quickRefreshBtn) {
                quickRefreshBtn.addEventListener('click', async (e) => {
                    await quickRefreshPr(prId, e.currentTarget);
                });
            }
            
            // Re-attach the click event listener to the view raw button
            const viewRawBtn = newRow.querySelector('.view-raw-btn');
            if (viewRawBtn) {
                viewRawBtn.addEventListener('click', (e) => {
                    showRawDataModal(prId);
                });
            }
        }

        async function updatePr(prId, button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Analyzing...';
            button.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                // Step 1: Refresh PR data from GitHub
                const refreshResponse = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pr_id: prId })
                });

                const refreshData = await refreshResponse.json();
                if (refreshData.error) {
                    showInlineError(`pr-row-${prId}`, refreshData.error);
                    button.innerHTML = '<i class="fas fa-chart-bar mr-1"></i>Analyze';
                    button.disabled = false;
                    button.classList.remove('opacity-70', 'cursor-not-allowed');
                    return;
                }

                // Clear cached readiness data for this PR since it's being refreshed
                clearReadinessData(prId);
                invalidateApiCache();

                // Check if PR was removed due to being merged/closed
                if (refreshData.removed) {
                    // Remove PR from allPrs array
                    const prIndex = allPrs.findIndex(pr => pr.id === prId);
                    if (prIndex !== -1) {
                        allPrs.splice(prIndex, 1);
                    }

                    // Get the row element
                    const row = document.getElementById(`pr-row-${prId}`);
                    if (row) {
                        // Add fade-out animation
                        row.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(20px)';

                        // Remove the row after animation completes
                        setTimeout(async () => {
                            row.remove();

                            // Update repos list (counts might have changed)
                            await loadRepos(true);

                            // If no visible PRs remain, reload to show remaining PRs
                            // from other pages rather than incorrectly showing empty state
                            if (allPrs.length === 0) {
                                currentPage = 1;
                                await loadPrs(true);
                            }
                        }, 300);
                    }

                    // Show success message
                    showError(refreshData.message || 'PR has been closed and removed from tracking');
                    await loadRateLimit(true);
                    return;
                }

                // Step 2: Analyze readiness
                const readinessResponse = await fetch(`/api/prs/${prId}/readiness`);
                const readinessData = await readinessResponse.json();

                if (readinessData.error) {
                    showInlineError(`pr-row-${prId}`, readinessData.error);
                    // Still update the row with the refreshed PR data even if readiness failed
                    updateSinglePrRow(prId, refreshData.data);
                    await loadRateLimit(true);
                    return;
                }

                const readiness = readinessData.readiness;
                const reviewHealth = readinessData.review_health;

                // Save readiness data to localStorage
                saveReadinessData(prId, readiness, reviewHealth);

                // Merge readiness results into the PR data so updateSinglePrRow can render
                // everything in one single glide â€” no two-step visual update.
                // Set readiness_computed_at to now since the backend just wrote CURRENT_TIMESTAMP
                // but doesn't return it in the readiness response.
                const nowIso = new Date().toISOString();
                const mergedData = {
                    ...refreshData.data,
                    overall_score: readiness.overall_score,
                    ci_score: readiness.ci_score,
                    review_score: readiness.review_score,
                    classification: readiness.classification,
                    merge_ready: readiness.merge_ready ? 1 : 0,
                    blockers: JSON.stringify(readiness.blockers || []),
                    warnings: JSON.stringify(readiness.warnings || []),
                    recommendations: JSON.stringify(readiness.recommendations || []),
                    review_health_classification: reviewHealth.classification,
                    review_health_score: reviewHealth.score,
                    response_rate: reviewHealth.response_rate,
                    total_feedback: reviewHealth.total_feedback,
                    responded_feedback: reviewHealth.responded_feedback,
                    stale_feedback_count: reviewHealth.stale_feedback_count,
                    stale_feedback: JSON.stringify(reviewHealth.stale_feedback || []),
                    readiness_computed_at: nowIso
                };

                // Single row replacement: refresh data + readiness in one smooth glide
                updateSinglePrRow(prId, mergedData);
                await loadRateLimit(true);

                // Button is already set to "Analyzed" inside updateSinglePrRow,
                // but ensure it's enabled in case the DOM ref shifted
                const updatedRow = document.getElementById(`pr-row-${prId}`);
                const updatedButton = updatedRow ? updatedRow.querySelector('.update-btn') : null;
                if (updatedButton) {
                    updatedButton.innerHTML = '<i class="fas fa-check mr-1"></i>Analyzed';
                    updatedButton.disabled = false;
                    updatedButton.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error('Error updating PR:', error);
                showInlineError(`pr-row-${prId}`, 'Failed to update PR');
                // Restore button to original state so it can be clicked again
                button.innerHTML = '<i class="fas fa-chart-bar mr-1"></i>Analyze';
                button.disabled = false;
                button.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }

        async function quickRefreshPr(prId, button) {
            const originalHtml = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                const refreshResponse = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pr_id: prId, quick_refresh: true })
                });

                const refreshData = await refreshResponse.json();
                if (refreshData.error) {
                    showInlineError(`pr-row-${prId}`, refreshData.error);
                    button.innerHTML = originalHtml;
                    button.disabled = false;
                    button.classList.remove('opacity-70', 'cursor-not-allowed');
                    return;
                }

                if (refreshData.removed) {
                    const prIndex = allPrs.findIndex(pr => pr.id === prId);
                    if (prIndex !== -1) allPrs.splice(prIndex, 1);
                    const row = document.getElementById(`pr-row-${prId}`);
                    if (row) {
                        row.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(20px)';
                        setTimeout(async () => {
                            row.remove();
                            await loadRepos(true);
                            if (allPrs.length === 0) { currentPage = 1; await loadPrs(true); }
                        }, 300);
                    }
                    showError(refreshData.message || 'PR has been closed and removed from tracking');
                    await loadRateLimit(true);
                    return;
                }

                invalidateApiCache();
                updateSinglePrRow(prId, refreshData.data);
                await loadRateLimit(true);

                const updatedRow = document.getElementById(`pr-row-${prId}`);
                const updatedBtn = updatedRow ? updatedRow.querySelector('.quick-refresh-btn') : null;
                if (updatedBtn) {
                    updatedBtn.innerHTML = '<i class="fas fa-check"></i>';
                    updatedBtn.disabled = false;
                    updatedBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error('Error quick-refreshing PR:', error);
                showInlineError(`pr-row-${prId}`, 'Failed to refresh PR');
                button.innerHTML = originalHtml;
                button.disabled = false;
                button.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }

        function updateInlineCells(prId, readiness, reviewHealth) {
            // Score color classes helper
            const getScoreColor = (score) => {
                if (score >= 70) return 'text-emerald-700 dark:text-emerald-400';
                if (score >= 60) return 'text-amber-600 dark:text-amber-400';
                if (score >= 40) return 'text-orange-600 dark:text-orange-400';
                return 'text-red-600 dark:text-red-400';
            };

            // Update Merge Ready Status
            const statusCell = document.getElementById(`readiness-status-${prId}`);
            if (statusCell) {
                const icon = readiness.merge_ready ? 'âœ…' : 'âŒ';
                statusCell.innerHTML = `<span class="text-base">${icon}</span>`;
            }

            // Update Ready Score
            const scoreCell = document.getElementById(`readiness-score-${prId}`);
            if (scoreCell) {
                const scoreClass = getScoreColor(readiness.overall_score);
                scoreCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${readiness.overall_score_display}</span>`;
            }

            // Update CI score
            const ciCell = document.getElementById(`readiness-ci-${prId}`);
            if (ciCell) {
                const scoreClass = getScoreColor(readiness.ci_score);
                ciCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${readiness.ci_score_display}</span>`;
            }

            // Update Review score
            const reviewCell = document.getElementById(`readiness-review-${prId}`);
            if (reviewCell) {
                const scoreClass = getScoreColor(readiness.review_score);
                reviewCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${readiness.review_score_display}</span>`;
            }

            // Update Response rate
            const responseCell = document.getElementById(`readiness-response-${prId}`);
            if (responseCell) {
                const responseScore = parseFloat(reviewHealth.response_rate_display.replace('%', ''));
                const scoreClass = getScoreColor(responseScore);
                responseCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${reviewHealth.response_rate_display}</span>`;
            }

            // Update Feedback
            const feedbackCell = document.getElementById(`readiness-feedback-${prId}`);
            if (feedbackCell) {
                const feedbackPercent = reviewHealth.total_feedback > 0 ?
                    (reviewHealth.responded_feedback / reviewHealth.total_feedback) * 100 : 100;
                const scoreClass = getScoreColor(feedbackPercent);
                feedbackCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${reviewHealth.responded_feedback}/${reviewHealth.total_feedback}</span>`;
            }

            // Update Issues/Blockers column
            const issuesCell = document.getElementById(`readiness-issues-${prId}`);
            if (issuesCell) {
                let issuesHTML = '<div class="text-xs space-y-0.5">';
                let hasIssues = false;

                // Show blockers
                if (readiness.blockers && readiness.blockers.length > 0) {
                    hasIssues = true;
                    issuesHTML += `<div class="flex items-start gap-1 text-red-700 dark:text-red-400">`;
                    issuesHTML += `<span class="font-bold">ðŸš«</span>`;
                    issuesHTML += `<span class="truncate" title="${escapeHtml(readiness.blockers.join('; '))}">${escapeHtml(readiness.blockers[0])}</span>`;
                    if (readiness.blockers.length > 1) {
                        issuesHTML += `<span class="font-semibold">+${readiness.blockers.length - 1}</span>`;
                    }
                    issuesHTML += `</div>`;
                }

                // Show warnings
                if (readiness.warnings && readiness.warnings.length > 0) {
                    hasIssues = true;
                    issuesHTML += `<div class="flex items-start gap-1 text-amber-700 dark:text-amber-400">`;
                    issuesHTML += `<span class="font-bold">âš ï¸</span>`;
                    issuesHTML += `<span class="truncate" title="${escapeHtml(readiness.warnings.join('; '))}">${escapeHtml(readiness.warnings[0])}</span>`;
                    if (readiness.warnings.length > 1) {
                        issuesHTML += `<span class="font-semibold">+${readiness.warnings.length - 1}</span>`;
                    }
                    issuesHTML += `</div>`;
                }

                // Show recommendations
                if (readiness.recommendations && readiness.recommendations.length > 0) {
                    hasIssues = true;
                    issuesHTML += `<div class="flex items-start gap-1 text-blue-700 dark:text-blue-400">`;
                    issuesHTML += `<span class="font-bold">ðŸ’¡</span>`;
                    issuesHTML += `<span class="truncate" title="${escapeHtml(readiness.recommendations.join('; '))}">${escapeHtml(readiness.recommendations[0])}</span>`;
                    if (readiness.recommendations.length > 1) {
                        issuesHTML += `<span class="font-semibold">+${readiness.recommendations.length - 1}</span>`;
                    }
                    issuesHTML += `</div>`;
                }

                if (!hasIssues) {
                    issuesHTML += '<span class="text-emerald-600 dark:text-emerald-400 font-semibold">âœ… All Clear</span>';
                }

                issuesHTML += '</div>';
                issuesCell.innerHTML = issuesHTML;
            }
        }

        function invalidateApiCache(path) {
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'INVALIDATE_API_CACHE',
                    path: path || '/api/'
                });
            }
        }

        async function addPr() {
            const input = document.getElementById('prUrlInput');
            const btn = document.getElementById('addPrBtn');
            const checkbox = document.getElementById('addAllPrsCheckbox');
            const prUrl = input.value.trim();
            const addAll = checkbox.checked;

            if (!prUrl) {
                showInputError('prUrlInput', 'Please enter a PR URL');
                return;
            }

            // Auto-detect if URL is an org or repo URL (not a PR URL)
            const isOrgOrRepoUrl = prUrl.match(/^https?:\/\/github\.com\/[^/]+\/?$/) || 
                                   (prUrl.match(/^https?:\/\/github\.com\/[^/]+\/[^/]+\/?$/) && !prUrl.includes('/pull/'));
            const effectiveAddAll = addAll || !!isOrgOrRepoUrl;

            btn.disabled = true;
            btn.textContent = effectiveAddAll ? 'Importing...' : 'Adding...';

            try {
                // If importing all, handle logic to send repo_url appropriately
                // But preserving your existing logic structure:
                const response = await fetch('/api/prs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pr_url: prUrl,
                        add_all: addAll
                    })
                });

                const data = await response.json();
                if (data.error) {
                    showInputError('prUrlInput', data.error);
                } else {
                    input.value = '';
                    // Show success message for bulk imports
                    if (data.imported_count !== undefined) {
                        if (data.truncated) {
                            showWarning(`Import Completed with Limit: ${data.message} More open PRs exist than can be imported at once.`);
                        } else {
                            showSuccess(data.message || 'Import completed successfully.');
                        }
                    }
                    invalidateApiCache();
                    // For single PR additions, select the org/repo and highlight the added PR
                    const prUrlPattern = /^https?:\/\/github\.com\/([a-zA-Z0-9._-]+)\/([a-zA-Z0-9._-]+)\/pull\/\d+/;
                    const prMatch = !effectiveAddAll && prUrl.match(prUrlPattern);
                    if (prMatch) {
                        const prOwner = prMatch[1];
                        const prRepoKey = `${prMatch[1]}/${prMatch[2]}`;
                        // Update org filter to highlight the PR's owner/org
                        currentOrg = prOwner;
                        localStorage.setItem('currentOrg', currentOrg);
                        const orgFilterInput = document.getElementById('orgFilterInput');
                        const orgFilterClearBtn = document.getElementById('orgFilterClearBtn');
                        if (orgFilterInput) orgFilterInput.value = prOwner;
                        if (orgFilterClearBtn) orgFilterClearBtn.classList.remove('hidden');
                        // Select the specific repo in the sidebar
                        currentRepo = prRepoKey;
                        localStorage.setItem('currentRepo', currentRepo);
                        currentPage = 1;
                        await loadRepos(true);
                        await loadPrs(true);
                        await loadRateLimit(true);
                        // Highlight the newly added PR row
                        const added = allPrs.find(pr => pr.pr_url === prUrl);
                        if (added) highlightPrRow(added.id);
                    } else {
                        // Force bypass service worker cache after import
                        await loadRepos(true);
                        await loadPrs(true);
                        await loadRateLimit(true);
                    }
                }
            } catch (error) {
                console.error('Error adding PR:', error);
                showInputError('prUrlInput', 'Failed to add PR');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add PR';
            }
        }

        async function addAllPrsFromRepo(repoOwner, repoName, buttonElement) {
            // Show loading state
            const originalHTML = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin text-xl text-red-600"></i>';

            try {
                const repoUrl = `https://github.com/${repoOwner}/${repoName}`;
                const response = await fetch('/api/prs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        pr_url: repoUrl,
                        add_all: true
                    })
                });

                const data = await response.json();
                if (data.error) {
                    showSectionMessage(`Failed to import PRs: ${data.error}`, 'error');
                } else {
                    // Show success message, with truncation warning if applicable
                    if (data.truncated) {
                        showWarning(`Import Completed with Limit: ${data.message} This repository has more open PRs than can be imported at once. You can manually add additional PRs using the "Add PR" form.`);
                    } else {
                        showSuccess(data.message || 'All open PRs were imported successfully.');
                    }
                    invalidateApiCache();
                    await loadRepos(true);
                    await loadPrs(true);
                    await loadRateLimit(true);
                }
            } catch (error) {
                console.error('Error importing PRs:', error);
                showSectionMessage(`Failed to import PRs from ${repoOwner}/${repoName}`, 'error');
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalHTML;
            }
        }

        // Theme toggle - handle both mobile and desktop buttons
        document.querySelectorAll('#themeToggle').forEach(btn => {
            btn.addEventListener('click', toggleTheme);
        });
        
        // Auto-refresh toggle - handle both mobile and desktop buttons
        document.querySelectorAll('#autoRefreshToggle').forEach(btn => {
            btn.addEventListener('click', toggleAutoRefresh);
        });
        
        // Search input - sync both mobile and desktop inputs
        document.querySelectorAll('#prSearchInput').forEach(input => {
            input.addEventListener('input', (e) => {
                currentPage = 1;
                filterPrs(e.target.value);
                // Sync the other input
                document.querySelectorAll('#prSearchInput').forEach(otherInput => {
                    if (otherInput !== e.target) {
                        otherInput.value = e.target.value;
                    }
                });
            });
            
            // Allow Enter key to trigger search
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = e.target.value;
                    filterPrs(searchTerm);
                }
            });
        });

        // Search button - handle both mobile and desktop buttons
        document.querySelectorAll('#searchBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const searchTerm = document.querySelector('#prSearchInput').value;
                filterPrs(searchTerm);
            });
        });

        // Clear button - handle both mobile and desktop buttons
        document.querySelectorAll('#clearSearchBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#prSearchInput').forEach(input => {
                    input.value = '';
                });
                filterPrs('');
            });
        });

        document.getElementById('addPrBtn').addEventListener('click', addPr);
        document.getElementById('prUrlInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPr();
        });

        document.querySelector('[data-repo="all"]').addEventListener('click', () => {
            currentRepo = 'all';
            currentPage = 1;
            localStorage.setItem('currentRepo', currentRepo);
            document.querySelectorAll('.repo-item').forEach(item => {
                setRepoItemActiveState(item, item.dataset.repo === currentRepo);
            });
            scrollToTop();
            loadPrs();
        });

        // Mobile dropdown functionality
        const repoDropdownButton = document.getElementById('repoDropdownButton');
        const repoDropdownMenu = document.getElementById('repoDropdownMenu');
        const repoSearchInput = document.getElementById('repoSearchInput');
        
        if (repoDropdownButton && repoDropdownMenu) {
            // Toggle dropdown on button click
            repoDropdownButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = repoDropdownMenu.classList.contains('hidden');
                if (isHidden) {
                    repoDropdownMenu.classList.remove('hidden');
                    updateMobileDropdown();
                    // Focus search input after opening
                    setTimeout(() => repoSearchInput?.focus(), 100);
                } else {
                    closeDropdown();
                }
            });
            
            // Handle search input
            if (repoSearchInput) {
                repoSearchInput.addEventListener('input', (e) => {
                    updateMobileDropdown(e.target.value);
                });
                
                // Prevent dropdown from closing when clicking search input
                repoSearchInput.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!repoDropdownButton.contains(e.target) && !repoDropdownMenu.contains(e.target)) {
                    closeDropdown();
                }
            });
        }

        // Theme toggle functionality
        function initTheme() {
            // Theme class is already set in the head, just update the icon
            const isDark = document.documentElement.classList.contains('dark');
            const themeIcons = document.querySelectorAll('#themeIcon');

            if (isDark) {
                themeIcons.forEach(icon => {
                    icon.className = 'fas fa-sun' + (icon.classList.contains('text-xs') ? ' text-xs' : '');
                });
            } else {
                themeIcons.forEach(icon => {
                    icon.className = 'fas fa-moon' + (icon.classList.contains('text-xs') ? ' text-xs' : '');
                });
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const themeIcons = document.querySelectorAll('#themeIcon');

            if (isDark) {
                document.documentElement.classList.remove('dark');
                themeIcons.forEach(icon => {
                    icon.className = 'fas fa-moon' + (icon.classList.contains('text-xs') ? ' text-xs' : '');
                });
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                themeIcons.forEach(icon => {
                    icon.className = 'fas fa-sun' + (icon.classList.contains('text-xs') ? ' text-xs' : '');
                });
                localStorage.setItem('theme', 'dark');
            }
        }

        // Raw data modal event listeners
        document.getElementById('closeRawDataModal').addEventListener('click', hideRawDataModal);
        document.getElementById('closeRawDataModalBtn').addEventListener('click', hideRawDataModal);
        document.getElementById('copyRawDataBtn').addEventListener('click', copyRawDataToClipboard);
        
        // Close modal when clicking outside
        document.getElementById('rawDataModal').addEventListener('click', (e) => {
            if (e.target.id === 'rawDataModal') {
                hideRawDataModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('rawDataModal');
                if (!modal.classList.contains('hidden')) {
                    hideRawDataModal();
                }
            }
        });

        // Make sortPrs globally accessible for onclick handlers
        window.sortPrs = sortPrs;

        // Set up event delegation for sorting (one-time setup)
        // This persists across table re-renders since prListContainer is stable
        const prListContainer = document.getElementById('prListContainer');
        prListContainer.addEventListener('click', async (e) => {
            // Handle sortable table header clicks
            const th = e.target.closest('th[data-sort-column]');
            if (th) {
                const column = th.getAttribute('data-sort-column');
                const isShiftClick = e.shiftKey;
                sortPrs(column, isShiftClick);
                return;
            }

            // Handle Clear Sort button
            if (e.target.closest('#clearSortBtn')) {
                sortColumns = [{ column: 'ready_score', direction: 'desc' }];
                localStorage.setItem('sortColumns', JSON.stringify(sortColumns));
                currentPage = 1;
                loadPrs();
                return;
            }

            // Handle Sort by Readiness button
            if (e.target.closest('#sortByReadinessBtn')) {
                sortColumns = [{ column: 'ready_score', direction: 'desc' }];
                localStorage.setItem('sortColumns', JSON.stringify(sortColumns));
                currentPage = 1;
                loadPrs();
                return;
            }

            // Handle Refresh PRs button (batch refresh from GitHub API)
            if (e.target.closest('#refreshPrsBtn')) {
                const btn = e.target.closest('#refreshPrsBtn');
                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                btn.classList.add('opacity-70', 'cursor-not-allowed');
                try {
                    const prIds = allPrs.map(pr => pr.id);
                    if (prIds.length > 0) {
                        const resp = await fetch('/api/refresh-batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ pr_ids: prIds })
                        });
                        if (!resp.ok) throw new Error(`Refresh failed (${resp.status})`);
                        const data = await resp.json();
                        if (data.error) throw new Error(data.error);
                    }
                    await loadPrs(true);
                } catch (err) {
                    showError(`Failed to refresh PRs: ${err.message}`);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
                return;
            }

            // Handle Analyze All button (run readiness analysis for every tracked PR)
            if (e.target.closest('#analyzeAllBtn')) {
                const ANALYZE_MAX_RETRIES = 3;
                // Default wait when the server doesn't tell us how long: full rate-limit window + 1s buffer
                const ANALYZE_DEFAULT_WAIT_SECS = 61;
                // Short delay before retrying on transient server errors (5xx)
                const ANALYZE_5XX_RETRY_DELAY_SECS = 5;
                const btn = e.target.closest('#analyzeAllBtn');
                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.classList.add('opacity-70', 'cursor-not-allowed');
                const total = allPrs.length;
                let done = 0;
                // Track failures as {id, reason} objects so the user can diagnose errors
                const failures = [];
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Analyzing 0/${total}...`;
                try {
                    for (const pr of allPrs) {
                        let retries = 0;
                        let succeeded = false;
                        while (retries < ANALYZE_MAX_RETRIES) {
                            try {
                                const resp = await fetch(`/api/prs/${pr.id}/readiness`);
                                if (resp.status === 429) {
                                    // App rate-limit â€” wait for server-provided retry_after then retry
                                    let waitSecs = ANALYZE_DEFAULT_WAIT_SECS;
                                    try {
                                        const errData = await resp.json();
                                        // Use server-provided retry_after (already includes buffer) when valid
                                        if (typeof errData.retry_after === 'number' && Number.isFinite(errData.retry_after)) {
                                            waitSecs = errData.retry_after;
                                        }
                                    } catch (_) {}
                                    for (let s = waitSecs; s > 0; s--) {
                                        btn.innerHTML = `<i class="fas fa-clock"></i> Rate limited, retrying in ${s}s... (${done}/${total})`;
                                        await new Promise(r => setTimeout(r, 1000));
                                    }
                                    retries++;
                                    continue;
                                }
                                if (resp.status >= 500) {
                                    // Server/GitHub API error â€” retry with short delay for transient failures
                                    let reason = `HTTP ${resp.status}`;
                                    try { const errData = await resp.json(); if (errData.error) reason = errData.error; } catch (_) {}
                                    retries++;
                                    if (retries < ANALYZE_MAX_RETRIES) {
                                        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Retrying PR ${pr.id} (${reason})...`;
                                        await new Promise(r => setTimeout(r, ANALYZE_5XX_RETRY_DELAY_SECS * 1000));
                                        continue;
                                    }
                                    failures.push({ id: pr.id, reason });
                                    break;
                                }
                                if (resp.ok) {
                                    const data = await resp.json();
                                    if (!data.error) {
                                        saveReadinessData(pr.id, data.readiness, data.review_health);
                                        updateInlineCells(pr.id, data.readiness, data.review_health);
                                        succeeded = true;
                                    } else {
                                        failures.push({ id: pr.id, reason: data.error });
                                    }
                                } else {
                                    // Non-429 non-5xx non-2xx (e.g. 404)
                                    let reason = `HTTP ${resp.status}`;
                                    try { const errData = await resp.json(); if (errData.error) reason = errData.error; } catch (_) {}
                                    failures.push({ id: pr.id, reason });
                                }
                                break;
                            } catch (networkErr) {
                                failures.push({ id: pr.id, reason: networkErr.message || 'Network error' });
                                break;
                            }
                        }
                        // 429 retries exhausted
                        if (!succeeded && retries >= ANALYZE_MAX_RETRIES && !failures.find(f => f.id === pr.id)) {
                            failures.push({ id: pr.id, reason: 'Rate limit retries exhausted' });
                        }
                        done++;
                        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Analyzing ${done}/${total}...`;
                    }
                    if (failures.length > 0) {
                        // Group by reason to give a concise diagnostic summary
                        const reasonCounts = failures.reduce((acc, f) => {
                            const key = f.reason.substring(0, 80);
                            acc[key] = (acc[key] || 0) + 1;
                            return acc;
                        }, {});
                        const reasonSummary = Object.entries(reasonCounts)
                            .map(([r, c]) => `${c}Ã— ${r}`)
                            .join('; ');
                        showError(`Analyze All: ${failures.length} PR${failures.length !== 1 ? 's' : ''} could not be analyzed â€” ${reasonSummary}`);
                    }
                } catch (err) {
                    showError(`Failed to analyze PRs: ${err.message}`);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
                return;
            }
        });

        // Handle ?pr= URL parameter: auto-add and highlight the specified PR
        function highlightPrRow(prId) {
            const row = document.getElementById(`pr-row-${prId}`);
            if (row) {
                activePrId = prId;
                row.classList.add('pr-row-active');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        async function handlePrUrlParam() {
            const params = new URLSearchParams(window.location.search);
            const ownerParam = params.get('owner');
            const repoParam = params.get('repo');
            const prParam = params.get('pr');

            // Support new format: ?owner=X&repo=Y&pr=N (PR number)
            // Support old format: ?pr=full_github_url
            let prUrl = null;
            let repoKey = null;

            // Basic validation for new format parameters
            const ownerValid = typeof ownerParam === 'string' && /^[a-zA-Z0-9._-]+$/.test(ownerParam);
            const repoValid = typeof repoParam === 'string' && /^[a-zA-Z0-9._-]+$/.test(repoParam);
            const prValid = typeof prParam === 'string' && /^\d+$/.test(prParam);

            if (ownerValid && repoValid && prValid) {
                // New format: construct the full PR URL from parts
                prUrl = `https://github.com/${ownerParam}/${repoParam}/pull/${prParam}`;
                repoKey = `${ownerParam}/${repoParam}`;
            } else if (prParam) {
                // Old format: only accept prParam if it looks like a GitHub PR URL
                const legacyPrUrlPattern = /^https?:\/\/github\.com\/([a-zA-Z0-9._-]+)\/([a-zA-Z0-9._-]+)\/pull\/\d+$/;
                const match = prParam.match(legacyPrUrlPattern);
                if (match) {
                    prUrl = prParam;
                    repoKey = `${match[1]}/${match[2]}`;
                }
            }

            if (!prUrl) return;

            // Pre-fill the input with the PR URL
            const input = document.getElementById('prUrlInput');
            if (input) input.value = prUrl;

            // Select the correct repo in the sidebar if needed
            if (repoKey && repoKey !== currentRepo) {
                currentRepo = repoKey;
                localStorage.setItem('currentRepo', currentRepo);
                updateMobileRepoDisplay();
                document.querySelectorAll('.repo-item').forEach(item => {
                    setRepoItemActiveState(item, item.dataset.repo === currentRepo);
                });
                await loadPrs();
            }

            // Check if the PR is already tracked
            const existing = allPrs.find(pr => pr.pr_url === prUrl);
            if (existing) {
                highlightPrRow(existing.id);
            } else {
                // Auto-add the PR, then highlight it
                await addPr();
                const added = allPrs.find(pr => pr.pr_url === prUrl);
                if (added) highlightPrRow(added.id);
            }
        }

        initTheme();
        loadRateLimit();
        loadLatestRelease();
        // initOrgFilter sets up event listeners only; dropdown items are populated from `repos`
        // on user interaction, so calling this before loadRepos() is safe.
        initOrgFilter();
        // initAuthorFilter sets up event listeners only; dropdown items are populated from /api/authors.
        initAuthorFilter();
        loadRepos();
        loadAuthors();
        loadPrs().then(handlePrUrlParam);
        setInterval(loadRateLimit, 600000);

        // Initialize auto-refresh
        updateAutoRefreshUI();
        if (autoRefreshEnabled) {
            startAutoRefresh();
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW Registered:', reg.scope))
                .catch(err => console.warn('SW Registration failed:', err));
        }
    </script>

    <!-- Footer -->
    <footer class="border-t border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800">
        <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
            <div class="space-y-4">
                <p class="text-sm text-slate-700 leading-relaxed dark:text-slate-300">
                    Leaf is a Readiness and Security PR checker. It reviews pull requests for operational readiness,
                    security risks, and production-impacting changes before they ship. Inspired by the surge of AI-generated
                    PRs, Leaf helps teams maintain high standards by adding an automated layer of critical thinking and risk
                    detection to every change.
                </p>
                <p class="text-sm font-medium text-slate-600 dark:text-slate-400">
                    ðŸ”’ Security features are coming soon!
                </p>
                <div class="pt-2 text-xs text-slate-500 dark:text-slate-500">
                    <p>Part of the <a href="https://owasp.org/www-project-bug-logging-tool/" target="_blank" rel="noopener noreferrer" class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">OWASP Bug Logging Tool (BLT)</a> project</p>
                </div>
                <!-- DB Status -->
                <div id="dbStatusBar" class="pt-2 flex flex-wrap items-center gap-3 text-xs text-slate-500 dark:text-slate-500">
                    <span class="font-medium">DB Status:</span>
                    <span id="dbStatusIndicator" class="inline-flex items-center gap-1">
                        <span class="inline-block h-2 w-2 rounded-full bg-slate-300 dark:bg-slate-600"></span>
                        <span>checkingâ€¦</span>
                    </span>
                    <span id="dbRowCounts" class="hidden">
                        &bull; PRs: <span id="dbPrsCount">â€”</span>
                        &bull; Timeline cache: <span id="dbTimelineCount">â€”</span>
                    </span>
                </div>
            </div>
        </div>
    </footer>
    <script>
        (async function loadDbStatus() {
            try {
                const res = await fetch('/api/status');
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                const indicator = document.getElementById('dbStatusIndicator');
                const rowCounts = document.getElementById('dbRowCounts');
                const prsCount = document.getElementById('dbPrsCount');
                const timelineCount = document.getElementById('dbTimelineCount');
                if (data.database_configured) {
                    indicator.innerHTML =
                        '<span class="inline-block h-2 w-2 rounded-full bg-green-500"></span>' +
                        '<span class="text-green-600 dark:text-green-400">Connected</span>';
                    prsCount.textContent = (data.row_counts && data.row_counts.prs != null) ? data.row_counts.prs : 'â€”';
                    timelineCount.textContent = (data.row_counts && data.row_counts.timeline_cache != null) ? data.row_counts.timeline_cache : 'â€”';
                    rowCounts.classList.remove('hidden');
                } else {
                    indicator.innerHTML =
                        '<span class="inline-block h-2 w-2 rounded-full bg-red-500"></span>' +
                        '<span class="text-red-600 dark:text-red-400">Not configured</span>';
                }
            } catch (err) {
                const indicator = document.getElementById('dbStatusIndicator');
                indicator.innerHTML =
                    '<span class="inline-block h-2 w-2 rounded-full bg-yellow-500"></span>' +
                    '<span class="text-yellow-600 dark:text-yellow-400">Unavailable</span>';
            }
        })();
    </script>
</body>

</html>
